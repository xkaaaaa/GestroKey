name: GestroKey CI/CD

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'è·³è¿‡å®é™…ç¼–è¯‘è¿‡ç¨‹ (true/false)'
        required: false
        default: 'false'
        type: boolean

# ä¸ºå·¥ä½œæµæ·»åŠ æƒé™
permissions:
  contents: write
  packages: read
  issues: read
  pull-requests: read

jobs:
  # æ£€æŸ¥æäº¤å†…å®¹ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰“åŒ…
  check-changes:
    name: æ£€æŸ¥ä»£ç å˜æ›´
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check_py_changes.outputs.changed }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´çš„æäº¤å†å²
      
      - name: è·å–ä¸Šæ¬¡æ‰“åŒ…æ ‡ç­¾
        id: last_tag
        run: |
          # è·å–æ‰€æœ‰æ ‡ç­¾å¹¶æŒ‰æ—¶é—´æ’åº
          tags=$(git tag --sort=-creatordate)
          latest_tag=$(echo "$tags" | grep -v "^latest$" | head -n 1)
          
          if [ -z "$latest_tag" ]; then
            # å¦‚æœæ²¡æœ‰æ ‡ç­¾ï¼Œåˆ™è®¾ç½®ä¸€ä¸ªåˆå§‹çš„SHA
            echo "LAST_TAG=$(git rev-list --max-parents=0 HEAD)" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ‰¾åˆ°ä¹‹å‰çš„æ ‡ç­¾ï¼Œå°†ä»é¦–æ¬¡æäº¤å¼€å§‹æ£€æŸ¥"
          else
            echo "LAST_TAG=$latest_tag" >> $GITHUB_OUTPUT
            echo "ä½¿ç”¨æœ€è¿‘çš„æ ‡ç­¾: $latest_tag"
          fi
      
      - name: æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†.pyæ–‡ä»¶
        id: check_py_changes
        run: |
          # è·å–ä¸Šæ¬¡å‘å¸ƒåä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨
          files_changed=$(git diff --name-only ${{ steps.last_tag.outputs.LAST_TAG }}..HEAD)
          
          # æ£€æŸ¥æ˜¯å¦æœ‰.pyæ–‡ä»¶è¢«ä¿®æ”¹
          py_changed=false
          while IFS= read -r file; do
            if [[ "$file" == *.py ]]; then
              py_changed=true
              echo "å‘ç°ä¿®æ”¹çš„Pythonæ–‡ä»¶: $file"
              break
            fi
          done <<< "$files_changed"
          
          # å¦‚æœå·¥ä½œæµæ˜¯æ‰‹åŠ¨è§¦å‘çš„ï¼Œå¹¶ä¸”ä¸æ˜¯è¦æ±‚è·³è¿‡æ„å»ºï¼Œé‚£ä¹ˆç»§ç»­æ„å»º
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.skip_build }}" != "true" ]]; then
            echo "æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼Œç»§ç»­æ„å»º"
            py_changed=true
          fi
          
          echo "changed=$py_changed" >> $GITHUB_OUTPUT
          
          if [ "$py_changed" == "true" ]; then
            echo "æ£€æµ‹åˆ°Pythonæ–‡ä»¶å˜æ›´ï¼Œå°†æ‰§è¡Œæ‰“åŒ…æµç¨‹"
          else
            echo "æœªæ£€æµ‹åˆ°Pythonæ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æ‰“åŒ…æµç¨‹"
          fi

  # è¯»å–ç‰ˆæœ¬ä¿¡æ¯ä½œä¸ºç‹¬ç«‹ä»»åŠ¡
  get-version:
    name: è¯»å–ç‰ˆæœ¬ä¿¡æ¯
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    outputs:
      version: ${{ steps.version_info.outputs.VERSION }}
      version_type: ${{ steps.version_info.outputs.VERSION_TYPE }}
      is_prerelease: ${{ steps.version_info.outputs.IS_PRERELEASE }}
      release_name: ${{ steps.version_info.outputs.RELEASE_NAME }}
      repo_url: ${{ steps.version_info.outputs.REPO_URL }}
      enable_packaging: ${{ steps.package_config.outputs.ENABLE_PACKAGING }}
      package_windows: ${{ steps.package_config.outputs.PACKAGE_WINDOWS }}
      package_macos: ${{ steps.package_config.outputs.PACKAGE_MACOS }}
      package_linux: ${{ steps.package_config.outputs.PACKAGE_LINUX }}
      package_standalone: ${{ steps.package_config.outputs.PACKAGE_STANDALONE }}
      package_portable: ${{ steps.package_config.outputs.PACKAGE_PORTABLE }}
      packager_windows: ${{ steps.package_config.outputs.PACKAGER_WINDOWS }}
      packager_macos: ${{ steps.package_config.outputs.PACKAGER_MACOS }}
      packager_linux: ${{ steps.package_config.outputs.PACKAGER_LINUX }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: è¯»å–ç‰ˆæœ¬ä¿¡æ¯
        id: version_info
        run: |
          # åˆ›å»ºä¸´æ—¶è„šæœ¬è¯»å–ç‰ˆæœ¬ä¿¡æ¯
          cat << EOF > temp_version_script.py
          import sys
          from src.version import VERSION, CURRENT_VERSION_TYPE, VERSION_TYPE_RELEASE, VERSION_TYPE_PREVIEW, VERSION_TYPE_DEVELOPMENT, REPO_URL
          
          # è¾“å‡ºç‰ˆæœ¬å·
          print(VERSION)
          
          # è¾“å‡ºç‰ˆæœ¬ç±»å‹ï¼ˆè‹±æ–‡ï¼‰
          if CURRENT_VERSION_TYPE == "æœªå‘å¸ƒç‰ˆ":
              print("development")
          elif CURRENT_VERSION_TYPE == "é¢„è§ˆç‰ˆ":
              print("preview")
          elif CURRENT_VERSION_TYPE == "æ­£å¼ç‰ˆ":
              print("release")
          else:
              print("unknown")
              
          # è¾“å‡ºä»“åº“URL
          print(REPO_URL)
          EOF
          
          # æ‰§è¡Œè„šæœ¬å¹¶è¯»å–è¾“å‡º
          IFS=$'\n' read -d '' -ra outputs < <(python temp_version_script.py && printf '\0')
          version="${outputs[0]}"
          version_type="${outputs[1]}"
          repo_url="${outputs[2]}"
          
          # åˆ é™¤ä¸´æ—¶è„šæœ¬
          rm temp_version_script.py
          
          # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "VERSION=$version" >> $GITHUB_OUTPUT
          echo "REPO_URL=$repo_url" >> $GITHUB_OUTPUT
          
          # æ ¹æ®è‹±æ–‡ç‰ˆæœ¬ç±»å‹åˆ¤æ–­è¦åˆ›å»ºçš„releaseåç§°å’Œæ˜¯å¦ä¸ºé¢„è§ˆç‰ˆ
          if [ "$version_type" = "development" ]; then
            echo "VERSION_TYPE=Development Version" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=999.999.999-latest" >> $GITHUB_OUTPUT
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
          elif [ "$version_type" = "preview" ]; then
            echo "VERSION_TYPE=Preview Version" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=$version-preview" >> $GITHUB_OUTPUT
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
          else
            echo "VERSION_TYPE=Release Version" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=$version" >> $GITHUB_OUTPUT
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
          fi

      - name: è¯»å–æ‰“åŒ…é…ç½®
        id: package_config
        run: |
          # åˆ›å»ºä¸´æ—¶è„šæœ¬è¯»å–æ‰“åŒ…é…ç½®
          cat << EOF > temp_package_script.py
          from src.version import ENABLE_PACKAGING, PACKAGE_WINDOWS, PACKAGE_MACOS, PACKAGE_LINUX
          from src.version import PACKAGE_STANDALONE, PACKAGE_PORTABLE
          from src.version import PACKAGER_WINDOWS, PACKAGER_MACOS, PACKAGER_LINUX
          
          # è¾“å‡ºæ‰“åŒ…æ§åˆ¶é€‰é¡¹
          print("true" if ENABLE_PACKAGING else "false")
          print("true" if PACKAGE_WINDOWS else "false")
          print("true" if PACKAGE_MACOS else "false")
          print("true" if PACKAGE_LINUX else "false")
          print("true" if PACKAGE_STANDALONE else "false")
          print("true" if PACKAGE_PORTABLE else "false")
          print(PACKAGER_WINDOWS)
          print(PACKAGER_MACOS)
          print(PACKAGER_LINUX)
          EOF
          
          # æ‰§è¡Œè„šæœ¬å¹¶è¯»å–è¾“å‡º
          IFS=$'\n' read -d '' -ra outputs < <(python temp_package_script.py && printf '\0')
          
          # è¾“å‡ºé…ç½®ä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "ENABLE_PACKAGING=${outputs[0]}" >> $GITHUB_OUTPUT
          echo "PACKAGE_WINDOWS=${outputs[1]}" >> $GITHUB_OUTPUT
          echo "PACKAGE_MACOS=${outputs[2]}" >> $GITHUB_OUTPUT
          echo "PACKAGE_LINUX=${outputs[3]}" >> $GITHUB_OUTPUT
          echo "PACKAGE_STANDALONE=${outputs[4]}" >> $GITHUB_OUTPUT
          echo "PACKAGE_PORTABLE=${outputs[5]}" >> $GITHUB_OUTPUT
          echo "PACKAGER_WINDOWS=${outputs[6]}" >> $GITHUB_OUTPUT
          echo "PACKAGER_MACOS=${outputs[7]}" >> $GITHUB_OUTPUT
          echo "PACKAGER_LINUX=${outputs[8]}" >> $GITHUB_OUTPUT
          
          # åˆ é™¤ä¸´æ—¶è„šæœ¬
          rm temp_package_script.py

  # æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•ä»»åŠ¡
  run-tests:
    name: è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [check-changes, get-version]
    if: needs.check-changes.outputs.should_build == 'true'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…æµ‹è¯•ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock coverage-badge anybadge
      
      - name: è¿è¡Œæµ‹è¯•å¹¶æ”¶é›†è¦†ç›–ç‡
        run: |
          pytest tests --cov=src --cov-report=xml --cov-report=html --verbose
      
      - name: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        run: |
          coverage report
          coverage xml
          
          # ç”Ÿæˆè¦†ç›–ç‡å¾½ç« 
          coverage_value=$(python -c "import xml.etree.ElementTree as ET; print(ET.parse('coverage.xml').getroot().get('line-rate'))")
          coverage_percentage=$(python -c "print(round(float($coverage_value) * 100))")
          
          echo "ä»£ç è¦†ç›–ç‡: $coverage_percentage%"
          
          # ç”Ÿæˆè¦†ç›–ç‡å¾½ç« 
          anybadge --value=$coverage_percentage --file=coverage-badge.svg --label=coverage --color=green:90 yellow:70 orange:50 red:0
      
      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            htmlcov/
            coverage.xml
            coverage-badge.svg
          retention-days: 7
          
      - name: æ€»ç»“æµ‹è¯•ç»“æœ
        run: |
          echo "æµ‹è¯•å·²å®Œæˆï¼Œæ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡"
          echo "ä»£ç è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆï¼Œå¯åœ¨æ„å»ºäº§ç‰©ä¸­æŸ¥çœ‹"

  # ä½¿ç”¨çŸ©é˜µæ„å»ºä¸åŒå¹³å°å’Œæ ¼å¼çš„åŒ…
  build:
    name: æ„å»º ${{ matrix.os }} ${{ matrix.package-type }}
    runs-on: ${{ matrix.os }}
    needs: [get-version, run-tests, code-quality, security-scan]
    if: needs.get-version.outputs.enable_packaging == 'true' && always() && needs.run-tests.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windowsæ„å»º
          - os: windows-latest
            package-type: standalone
            if: ${{ needs.get-version.outputs.package_windows == 'true' && needs.get-version.outputs.package_standalone == 'true' }}
          - os: windows-latest
            package-type: portable
            if: ${{ needs.get-version.outputs.package_windows == 'true' && needs.get-version.outputs.package_portable == 'true' }}
          # Linuxæ„å»º
          - os: ubuntu-latest
            package-type: standalone
            if: ${{ needs.get-version.outputs.package_linux == 'true' && needs.get-version.outputs.package_standalone == 'true' }}
          - os: ubuntu-latest
            package-type: portable
            if: ${{ needs.get-version.outputs.package_linux == 'true' && needs.get-version.outputs.package_portable == 'true' }}
          # macOSæ„å»º
          - os: macos-latest
            package-type: standalone
            if: ${{ needs.get-version.outputs.package_macos == 'true' && needs.get-version.outputs.package_standalone == 'true' }}
          - os: macos-latest
            package-type: portable
            if: ${{ needs.get-version.outputs.package_macos == 'true' && needs.get-version.outputs.package_portable == 'true' }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          
      # ç¼“å­˜ä¼˜åŒ– - ä¿å­˜pipä¸‹è½½çš„åŒ…
      - name: ç¼“å­˜pipåŒ…
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ${{ env.pythonLocation }}
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      # ç¼“å­˜ä¼˜åŒ– - Nuitkaç¼–è¯‘ç¼“å­˜
      - name: ç¼“å­˜Nuitkaç¼–è¯‘
        uses: actions/cache@v3
        if: contains(fromJSON('["nuitka"]'), needs.get-version.outputs.packager_windows) || contains(fromJSON('["nuitka"]'), needs.get-version.outputs.packager_linux)
        with:
          path: |
            ~/.cache/Nuitka
            ~/.cache/ccache
          key: ${{ runner.os }}-nuitka-${{ hashFiles('src/**/*.py') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-
            
      # ç¼“å­˜ä¼˜åŒ– - PyInstallerç¼–è¯‘ç¼“å­˜
      - name: ç¼“å­˜PyInstaller
        uses: actions/cache@v3
        if: contains(fromJSON('["pyinstaller"]'), needs.get-version.outputs.packager_windows) || contains(fromJSON('["pyinstaller"]'), needs.get-version.outputs.packager_linux) || matrix.os == 'macos-latest'
        with:
          path: |
            ~/.cache/PyInstaller
          key: ${{ runner.os }}-pyinstaller-${{ hashFiles('src/**/*.py') }}
          restore-keys: |
            ${{ runner.os }}-pyinstaller-
            
      # ä¼˜åŒ– - å®‰è£…ccacheç”¨äºç¼–è¯‘åŠ é€Ÿ
      - name: å®‰è£…ccache (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            sudo apt-get update
            sudo apt-get install -y ccache
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            brew install ccache
          fi
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV
          
      # ä¼˜åŒ– - é…ç½®ccache (Linux/macOS)
      - name: é…ç½®ccache (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          ccache -M 500M
          ccache -s

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install nuitka setuptools wheel
          pip install -r requirements.txt
          
      # ä¸ºmacOSå®‰è£…PyInstaller
      - name: macOS - å®‰è£…PyInstaller
        if: matrix.os == 'macos-latest'
        run: |
          pip install pyinstaller
          
      # Windowsç‰¹å®šå®‰è£…
      - name: Windows - å®‰è£…å·¥å…·
        if: matrix.os == 'windows-latest'
        run: |
          choco install imagemagick -y

      # macOSç‰¹å®šå®‰è£…
      - name: macOS - å®‰è£…å·¥å…·
        if: matrix.os == 'macos-latest'
        run: |
          brew install imagemagick

      # Linuxç‰¹å®šå®‰è£…
      - name: Linux - å®‰è£…å·¥å…·
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick fakeroot

      # å¤„ç†å›¾æ ‡ - Windows
      - name: Windows - å¤„ç†å›¾æ ‡
        if: matrix.os == 'windows-latest'
        run: |
          if (-Not (Test-Path -Path "src/assets/images")) {
            mkdir -p src/assets/images
          }
          if (Test-Path -Path src/assets/images/icon.svg) {
            # ç¡®ä¿ä½¿ç”¨24ä½PNGæ ¼å¼å¹¶ä¿ç•™alphaé€šé“
            magick src/assets/images/icon.svg -background transparent -define png:color-type=6 -resize 256x256 icon-256.png
            magick src/assets/images/icon.svg -background transparent -define png:color-type=6 -resize 128x128 icon-128.png
            magick src/assets/images/icon.svg -background transparent -define png:color-type=6 -resize 64x64 icon-64.png
            magick src/assets/images/icon.svg -background transparent -define png:color-type=6 -resize 48x48 icon-48.png
            magick src/assets/images/icon.svg -background transparent -define png:color-type=6 -resize 32x32 icon-32.png
            magick src/assets/images/icon.svg -background transparent -define png:color-type=6 -resize 16x16 icon-16.png
            
            # ä½¿ç”¨è½¬æ¢åçš„PNGæ–‡ä»¶åˆ›å»ºå¸¦é€æ˜åº¦çš„ICOæ–‡ä»¶
            magick convert icon-256.png icon-128.png icon-64.png icon-48.png icon-32.png icon-16.png -alpha on -background transparent src/assets/images/icon.ico
            
            Remove-Item icon-*.png
          } else {
            Write-Error "ç¼ºå°‘å›¾æ ‡æ–‡ä»¶: src/assets/images/icon.svg"
            exit 1
          }

      # å¤„ç†å›¾æ ‡ - macOS
      - name: macOS - å¤„ç†å›¾æ ‡
        if: matrix.os == 'macos-latest'
        run: |
          if [ ! -d "src/assets/images" ]; then
            mkdir -p src/assets/images
          fi
          if [ -f src/assets/images/icon.svg ]; then
            # åˆ›å»ºæ­£ç¡®çš„iconsetç›®å½•
            mkdir -p "iconset.iconset"
            # ä½¿ç”¨magickå‘½ä»¤æ›¿ä»£convert
            for size in 16 32 64 128 256 512 1024; do
              magick src/assets/images/icon.svg -background none -resize ${size}x${size} "iconset.iconset/icon_${size}x${size}.png"
              # ä¸ºRetinaæ˜¾ç¤ºåˆ›å»º@2xç‰ˆæœ¬
              if [ "$size" -le "512" ]; then
                dsize=$((size*2))
                magick src/assets/images/icon.svg -background none -resize ${dsize}x${dsize} "iconset.iconset/icon_${size}x${size}@2x.png"
              fi
            done
            # ä½¿ç”¨æ­£ç¡®æ ¼å¼åˆ›å»ºicnsæ–‡ä»¶
            iconutil -c icns -o src/assets/images/icon.icns "iconset.iconset"
            rm -rf "iconset.iconset"
          else
            echo "ç¼ºå°‘å›¾æ ‡æ–‡ä»¶: src/assets/images/icon.svg"
            exit 1
          fi

      # å¤„ç†å›¾æ ‡ - Linux
      - name: Linux - å¤„ç†å›¾æ ‡
        if: matrix.os == 'ubuntu-latest'
        run: |
          if [ ! -d "src/assets/images" ]; then
            mkdir -p src/assets/images
          fi
          if [ -f src/assets/images/icon.svg ]; then
            convert -background none src/assets/images/icon.svg -resize 256x256 src/assets/images/icon.png
          else
            echo "ç¼ºå°‘å›¾æ ‡æ–‡ä»¶: src/assets/images/icon.svg"
            exit 1
          fi

      # æ„å»ºå¤šæ–‡ä»¶ä¾¿æºç‰ˆ - Windows (Nuitka)
      - name: æ„å»ºä¾¿æºç‰ˆ - Windows (Nuitka)
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build != 'true' && matrix.os == 'windows-latest' && needs.get-version.outputs.packager_windows == 'nuitka'
        shell: pwsh
        run: |
          python -m nuitka --standalone --enable-plugin=pyqt6 --include-data-dir=src/assets=assets --include-data-files=src/ui/settings/default_settings.json=ui/settings/default_settings.json --include-data-files=src/ui/gestures/default_gestures.json=ui/gestures/default_gestures.json --windows-icon-from-ico=src/assets/images/icon.ico --output-dir=dist --assume-yes-for-downloads src/main.py
          mkdir -Force -Path "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable"
          Copy-Item -Path dist/main.dist/* -Destination "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable/" -Recurse
          Compress-Archive -Path "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable/*" -DestinationPath "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable.zip" -Force

      # æ„å»ºå¤šæ–‡ä»¶ä¾¿æºç‰ˆ - Windows (PyInstaller)
      - name: æ„å»ºä¾¿æºç‰ˆ - Windows (PyInstaller)
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build != 'true' && matrix.os == 'windows-latest' && needs.get-version.outputs.packager_windows == 'pyinstaller'
        shell: pwsh
        run: |
          pip install pyinstaller
          pyinstaller --name=GestroKey --windowed --noconfirm --add-data="src/assets;assets" --add-data="src/ui/settings/default_settings.json;ui/settings" --add-data="src/ui/gestures/default_gestures.json;ui/gestures" --icon=src/assets/images/icon.ico src/main.py
          mkdir -Force -Path "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable"
          Copy-Item -Path dist/GestroKey/* -Destination "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable/" -Recurse
          Compress-Archive -Path "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable/*" -DestinationPath "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable.zip" -Force

      # æ„å»ºå¤šæ–‡ä»¶ä¾¿æºç‰ˆ - Linux (Nuitka)
      - name: æ„å»ºä¾¿æºç‰ˆ - Linux (Nuitka)
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build != 'true' && matrix.os == 'ubuntu-latest' && needs.get-version.outputs.packager_linux == 'nuitka'
        shell: bash
        run: |
          python -m nuitka --standalone --enable-plugin=pyqt6 --include-data-dir=src/assets=assets --include-data-files=src/ui/settings/default_settings.json=ui/settings/default_settings.json --include-data-files=src/ui/gestures/default_gestures.json=ui/gestures/default_gestures.json --output-dir=dist --assume-yes-for-downloads src/main.py
          mkdir -p "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable"
          cp -r dist/main.dist/* "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable/"
          cd dist && tar -czvf "GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable.tar.gz" "GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable"

      # æ„å»ºå¤šæ–‡ä»¶ä¾¿æºç‰ˆ - Linux (PyInstaller)
      - name: æ„å»ºä¾¿æºç‰ˆ - Linux (PyInstaller)
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build != 'true' && matrix.os == 'ubuntu-latest' && needs.get-version.outputs.packager_linux == 'pyinstaller'
        shell: bash
        run: |
          pip install pyinstaller
          pyinstaller --name=GestroKey --windowed --noconfirm --add-data="src/assets:assets" --add-data="src/ui/settings/default_settings.json:ui/settings" --add-data="src/ui/gestures/default_gestures.json:ui/gestures" src/main.py
          mkdir -p "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable"
          cp -r dist/GestroKey/* "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable/"
          cd dist && tar -czvf "GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable.tar.gz" "GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable"

      # æ„å»ºå¤šæ–‡ä»¶ä¾¿æºç‰ˆ - macOS (ä½¿ç”¨PyInstaller)
      - name: æ„å»ºä¾¿æºç‰ˆ - macOS
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build != 'true' && matrix.os == 'macos-latest' && needs.get-version.outputs.packager_macos == 'pyinstaller'
        shell: bash
        run: |
          # åˆ›å»ºspecæ–‡ä»¶
          cat > GestroKey.spec << EOF
          # -*- mode: python ; coding: utf-8 -*-
          
          a = Analysis(
              ['src/main.py'],
              pathex=[],
              binaries=[],
              datas=[
                  ('src/assets', 'assets'),
                  ('src/ui/settings/default_settings.json', 'ui/settings'),
                  ('src/ui/gestures/default_gestures.json', 'ui/gestures')
              ],
              hiddenimports=[],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              noarchive=False,
          )
          
          pyz = PYZ(a.pure)
          
          exe = EXE(
              pyz,
              a.scripts,
              [],
              exclude_binaries=True,
              name='GestroKey',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=True,
              console=False,
              disable_windowed_traceback=False,
              argv_emulation=True,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
              icon='src/assets/images/icon.icns',
          )
          
          coll = COLLECT(
              exe,
              a.binaries,
              a.datas,
              strip=False,
              upx=True,
              upx_exclude=[],
              name='GestroKey',
          )
          
          app = BUNDLE(
              coll,
              name='GestroKey.app',
              icon='src/assets/images/icon.icns',
              bundle_identifier=None,
              info_plist={
                  'NSHighResolutionCapable': 'True',
                  'CFBundleShortVersionString': '${{ needs.get-version.outputs.version }}',
                  'CFBundleVersion': '${{ needs.get-version.outputs.version }}',
                  'CFBundleName': 'GestroKey',
                  'CFBundleDisplayName': 'GestroKey',
                  'CFBundleExecutable': 'GestroKey',
              },
          )
          EOF
          
          # ä½¿ç”¨PyInstalleræ„å»º
          pyinstaller GestroKey.spec
          
          # æ‰“åŒ…
          mkdir -p "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable"
          cp -r dist/GestroKey.app "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable/"
          cd dist && zip -r "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable.zip" "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable"

      # æ„å»ºå•æ–‡ä»¶ç‰ˆæœ¬ - Windows
      - name: æ„å»ºå•æ–‡ä»¶ç‰ˆ - Windows (Nuitka)
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build != 'true' && matrix.os == 'windows-latest' && needs.get-version.outputs.packager_windows == 'nuitka'
        shell: pwsh
        run: |
          python -m nuitka --onefile --enable-plugin=pyqt6 --include-data-dir=src/assets=assets --include-data-files=src/ui/settings/default_settings.json=ui/settings/default_settings.json --include-data-files=src/ui/gestures/default_gestures.json=ui/gestures/default_gestures.json --windows-icon-from-ico=src/assets/images/icon.ico --output-dir=dist --assume-yes-for-downloads src/main.py
          Move-Item -Path dist/main.exe -Destination "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Standalone.exe"

      # æ„å»ºå•æ–‡ä»¶ç‰ˆæœ¬ - Windows (PyInstaller)
      - name: æ„å»ºå•æ–‡ä»¶ç‰ˆ - Windows (PyInstaller)
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build != 'true' && matrix.os == 'windows-latest' && needs.get-version.outputs.packager_windows == 'pyinstaller'
        shell: pwsh
        run: |
          pip install pyinstaller
          pyinstaller --name=GestroKey --onefile --windowed --noconfirm --add-data="src/assets;assets" --add-data="src/ui/settings/default_settings.json;ui/settings" --add-data="src/ui/gestures/default_gestures.json;ui/gestures" --icon=src/assets/images/icon.ico src/main.py
          Move-Item -Path dist/GestroKey.exe -Destination "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Standalone.exe"

      # æ„å»ºå•æ–‡ä»¶ç‰ˆæœ¬ - Linux
      - name: æ„å»ºå•æ–‡ä»¶ç‰ˆ - Linux (Nuitka)
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build != 'true' && matrix.os == 'ubuntu-latest' && needs.get-version.outputs.packager_linux == 'nuitka'
        shell: bash
        run: |
          python -m nuitka --onefile --enable-plugin=pyqt6 --include-data-dir=src/assets=assets --include-data-files=src/ui/settings/default_settings.json=ui/settings/default_settings.json --include-data-files=src/ui/gestures/default_gestures.json=ui/gestures/default_gestures.json --output-dir=dist --assume-yes-for-downloads src/main.py
          mv dist/main.bin "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Standalone"
          chmod +x "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Standalone"

      # æ„å»ºå•æ–‡ä»¶ç‰ˆæœ¬ - Linux (PyInstaller)
      - name: æ„å»ºå•æ–‡ä»¶ç‰ˆ - Linux (PyInstaller)
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build != 'true' && matrix.os == 'ubuntu-latest' && needs.get-version.outputs.packager_linux == 'pyinstaller'
        shell: bash
        run: |
          pip install pyinstaller
          pyinstaller --name=GestroKey --onefile --windowed --noconfirm --add-data="src/assets:assets" --add-data="src/ui/settings/default_settings.json:ui/settings" --add-data="src/ui/gestures/default_gestures.json:ui/gestures" src/main.py
          mv dist/GestroKey "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Standalone"
          chmod +x "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Standalone"

      # æ„å»ºå•æ–‡ä»¶ç‰ˆæœ¬ - macOS (ä½¿ç”¨PyInstaller)
      - name: æ„å»ºå•æ–‡ä»¶ç‰ˆ - macOS
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build != 'true' && matrix.os == 'macos-latest' && needs.get-version.outputs.packager_macos == 'pyinstaller'
        shell: bash
        run: |
          # åˆ›å»ºspecæ–‡ä»¶
          cat > GestroKey_onefile.spec << EOF
          # -*- mode: python ; coding: utf-8 -*-
          
          a = Analysis(
              ['src/main.py'],
              pathex=[],
              binaries=[],
              datas=[
                  ('src/assets', 'assets'),
                  ('src/ui/settings/default_settings.json', 'ui/settings'),
                  ('src/ui/gestures/default_gestures.json', 'ui/gestures')
              ],
              hiddenimports=[],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              noarchive=False,
          )
          
          pyz = PYZ(a.pure)
          
          exe = EXE(
              pyz,
              a.scripts,
              a.binaries,
              a.datas,
              [],
              name='GestroKey',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=True,
              upx_exclude=[],
              runtime_tmpdir=None,
              console=False,
              disable_windowed_traceback=False,
              argv_emulation=True,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
              icon='src/assets/images/icon.icns',
          )
          
          app = BUNDLE(
              exe,
              name='GestroKey.app',
              icon='src/assets/images/icon.icns',
              bundle_identifier=None,
              info_plist={
                  'NSHighResolutionCapable': 'True',
                  'CFBundleShortVersionString': '${{ needs.get-version.outputs.version }}',
                  'CFBundleVersion': '${{ needs.get-version.outputs.version }}',
                  'CFBundleName': 'GestroKey',
                  'CFBundleDisplayName': 'GestroKey',
                  'CFBundleExecutable': 'GestroKey',
              },
          )
          EOF
          
          # ä½¿ç”¨PyInstalleræ„å»º
          pyinstaller GestroKey_onefile.spec
          
          # æ‰“åŒ…
          mkdir -p "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone"
          cp -r dist/GestroKey.app "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone/GestroKey.app"
          cd dist && zip -r "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone.zip" "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone"

      # æ¨¡æ‹Ÿæ„å»ºä¾¿æºç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Windows
      - name: æ¨¡æ‹Ÿæ„å»ºä¾¿æºç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Windows
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build == 'true' && matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          echo "è·³è¿‡ç¼–è¯‘è¿‡ç¨‹ï¼Œåˆ›å»ºWindowsä¾¿æºç‰ˆè™šæ‹ŸåŒ…..."
          mkdir -Force -Path "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable"
          "æ¨¡æ‹Ÿæ„å»º" | Out-File -FilePath "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable/README.txt"
          Compress-Archive -Path "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable/*" -DestinationPath "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable.zip" -Force

      # æ¨¡æ‹Ÿæ„å»ºä¾¿æºç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Linux
      - name: æ¨¡æ‹Ÿæ„å»ºä¾¿æºç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Linux
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build == 'true' && matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          echo "è·³è¿‡ç¼–è¯‘è¿‡ç¨‹ï¼Œåˆ›å»ºLinuxä¾¿æºç‰ˆè™šæ‹ŸåŒ…..."
          mkdir -p "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable"
          echo "æ¨¡æ‹Ÿæ„å»º" > "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable/README.txt"
          cd dist && tar -czvf "GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable.tar.gz" "GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable"

      # æ¨¡æ‹Ÿæ„å»ºä¾¿æºç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- macOS
      - name: æ¨¡æ‹Ÿæ„å»ºä¾¿æºç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- macOS
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build == 'true' && matrix.os == 'macos-latest'
        shell: bash
        run: |
          echo "è·³è¿‡ç¼–è¯‘è¿‡ç¨‹ï¼Œåˆ›å»ºmacOSä¾¿æºç‰ˆè™šæ‹ŸåŒ…..."
          mkdir -p "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable"
          echo "æ¨¡æ‹Ÿæ„å»º" > "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable/README.txt"
          cd dist && zip -r "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable.zip" "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable"

      # æ¨¡æ‹Ÿæ„å»ºå•æ–‡ä»¶ç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Windows
      - name: æ¨¡æ‹Ÿæ„å»ºå•æ–‡ä»¶ç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Windows
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build == 'true' && matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          echo "è·³è¿‡ç¼–è¯‘è¿‡ç¨‹ï¼Œåˆ›å»ºWindowså•æ–‡ä»¶ç‰ˆè™šæ‹ŸåŒ…..."
          mkdir -Force -Path dist
          "æ¨¡æ‹Ÿæ„å»º" | Out-File -FilePath "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Standalone.exe"

      # æ¨¡æ‹Ÿæ„å»ºå•æ–‡ä»¶ç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Linux
      - name: æ¨¡æ‹Ÿæ„å»ºå•æ–‡ä»¶ç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Linux
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build == 'true' && matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          echo "è·³è¿‡ç¼–è¯‘è¿‡ç¨‹ï¼Œåˆ›å»ºLinuxå•æ–‡ä»¶ç‰ˆè™šæ‹ŸåŒ…..."
          mkdir -p dist
          echo "æ¨¡æ‹Ÿæ„å»º" > "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Standalone"
          chmod +x "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Standalone"

      # æ¨¡æ‹Ÿæ„å»ºå•æ–‡ä»¶ç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- macOS
      - name: æ¨¡æ‹Ÿæ„å»ºå•æ–‡ä»¶ç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- macOS
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build == 'true' && matrix.os == 'macos-latest'
        shell: bash
        run: |
          echo "è·³è¿‡ç¼–è¯‘è¿‡ç¨‹ï¼Œåˆ›å»ºmacOSå•æ–‡ä»¶ç‰ˆè™šæ‹ŸåŒ…..."
          mkdir -p dist
          echo "æ¨¡æ‹Ÿæ„å»º" > "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone"
          chmod +x "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone"

      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: GestroKey-${{ needs.get-version.outputs.version }}-${{ matrix.os }}-${{ matrix.package-type }}
          path: |
            dist/GestroKey-*.exe
            dist/GestroKey-*.zip
            dist/GestroKey-*.dmg
            dist/GestroKey-*.tar.gz
            dist/GestroKey-*-Standalone
            dist/GestroKey-*-Standalone.exe

  # åˆ›å»ºå‘å¸ƒ
  release:
    name: åˆ›å»ºç‰ˆæœ¬å‘å¸ƒ
    runs-on: ubuntu-latest
    needs: [get-version, build, check-changes]
    if: always() && needs.check-changes.outputs.should_build == 'true' && needs.get-version.outputs.enable_packaging == 'true'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ä»¥ä¾¿è·å–æ‰€æœ‰æ ‡ç­¾å’Œæäº¤

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
        run: find artifacts -type f | sort

      - name: è·å–æäº¤è®°å½•å¹¶ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: generate_changelog
        run: |
          # æ ¹æ®ç‰ˆæœ¬ç±»å‹ç¡®å®šä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾
          version_type="${{ needs.get-version.outputs.version_type }}"
          current_tag="${{ needs.get-version.outputs.release_name }}"
          current_version="${{ needs.get-version.outputs.version }}"
          
          # è·å–æ‰€æœ‰æ ‡ç­¾å¹¶æŒ‰ç‰ˆæœ¬æ’åº
          all_tags=$(git tag -l | grep -v "latest" | grep -v "999.999.999-latest" | sort -V)
          
          # æ ¹æ®ç‰ˆæœ¬ç±»å‹æŸ¥æ‰¾ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾
          if [[ "$version_type" == "Development Version" ]]; then
            # æœªå‘å¸ƒç‰ˆï¼šç›®å‰æœ€æ–°çš„ç‰ˆæœ¬
            previous_tag=$(echo "$all_tags" | tail -n 1)
          elif [[ "$version_type" == "Preview Version" ]]; then
            # é¢„è§ˆç‰ˆï¼šé™¤latestå¤–çš„æœ€æ–°ç‰ˆæœ¬
            previous_tag=$(echo "$all_tags" | grep -v "$current_tag" | tail -n 1)
          else
            # å‘è¡Œç‰ˆï¼šä¸Šä¸€ä¸ªå‘è¡Œç‰ˆ
            previous_tag=$(echo "$all_tags" | grep -v "preview" | grep -v "$current_tag" | tail -n 1)
          fi
          
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾ï¼Œåˆ™ä¸ç”Ÿæˆæ›´æ–°æ—¥å¿—
          if [[ -z "$previous_tag" || "$previous_tag" == "$current_tag" ]]; then
            echo "æ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾ï¼Œè·³è¿‡æ›´æ–°æ—¥å¿—ç”Ÿæˆ"
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            echo "<div align='center'><h2>ğŸ‰ é¦–æ¬¡å‘å¸ƒ</h2></div>" >> $GITHUB_OUTPUT
            echo "<p>è¿™æ˜¯GestroKeyçš„é¦–ä¸ªç‰ˆæœ¬ï¼Œæ— æ›´æ–°æ—¥å¿—ã€‚</p>" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "å½“å‰ç‰ˆæœ¬ï¼š$current_tagï¼Œä¸Šä¸€ç‰ˆæœ¬ï¼š$previous_tag"
          
          # è·å–æäº¤è®°å½•
          commits=$(git log --pretty=format:"%h|%an|%at|%s" $previous_tag..HEAD)
          
          # åˆå§‹åŒ–å„ç±»åˆ«çš„å†…å®¹
          new_features=""
          fixes=""
          improvements=""
          others=""
          
          # è·å–æ—¶é—´
          current_date=$(date "+%Y-%m-%d")
          
          # è§£ææäº¤ä¿¡æ¯
          while IFS= read -r commit; do
            # åˆ†è§£æäº¤ä¿¡æ¯
            hash=$(echo "$commit" | cut -d'|' -f1)
            author=$(echo "$commit" | cut -d'|' -f2)
            timestamp=$(echo "$commit" | cut -d'|' -f3)
            message=$(echo "$commit" | cut -d'|' -f4)
            
            # æ ¼å¼åŒ–æ—¥æœŸ
            commit_date=$(date -d @$timestamp "+%Y-%m-%d")
            
            # æäº¤é“¾æ¥
            commit_link="[\`${hash:0:7}\`](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${hash})"
            
            # æ ¹æ®æäº¤æ¶ˆæ¯ç±»å‹åˆ†ç±»
            if [[ "$message" =~ ^æ–°å¢ï¼š(.+) ]]; then
              content="${BASH_REMATCH[1]}"
              new_features="${new_features}- **${content}** ${commit_link} - *${commit_date}*\n"
            elif [[ "$message" =~ ^ä¿®å¤ï¼š(.+) ]]; then
              content="${BASH_REMATCH[1]}"
              fixes="${fixes}- **${content}** ${commit_link} - *${commit_date}*\n"
            elif [[ "$message" =~ ^æ”¹è¿›ï¼š(.+) ]]; then
              content="${BASH_REMATCH[1]}"
              improvements="${improvements}- **${content}** ${commit_link} - *${commit_date}*\n"
            else
              others="${others}- ${message} ${commit_link} - *${commit_date}*\n"
            fi
          done <<< "$commits"
          
          # ç”Ÿæˆç¾è§‚çš„æ›´æ–°æ—¥å¿—
          changelog="<div align='center'><h2>ğŸ“‹ æ›´æ–°æ—¥å¿—</h2></div>\n\n"
          changelog="${changelog}<p align='right'><i>å‘å¸ƒäº: ${current_date}</i></p>\n\n"
          changelog="${changelog}<p>ç‰ˆæœ¬ <b>${current_version}</b> ç›¸æ¯” <b>${previous_tag}</b> çš„å˜æ›´ï¼š</p>\n\n"
          
          if [[ -n "$new_features" ]]; then
            changelog="${changelog}<details open>\n<summary><h3>âœ¨ æ–°å¢åŠŸèƒ½</h3></summary>\n\n${new_features}\n</details>\n\n"
          fi
          
          if [[ -n "$fixes" ]]; then
            changelog="${changelog}<details open>\n<summary><h3>ğŸ› é—®é¢˜ä¿®å¤</h3></summary>\n\n${fixes}\n</details>\n\n"
          fi
          
          if [[ -n "$improvements" ]]; then
            changelog="${changelog}<details open>\n<summary><h3>âš¡ åŠŸèƒ½æ”¹è¿›</h3></summary>\n\n${improvements}\n</details>\n\n"
          fi
          
          if [[ -n "$others" ]]; then
            changelog="${changelog}<details>\n<summary><h3>ğŸ”„ å…¶å®ƒå˜æ›´</h3></summary>\n\n${others}\n</details>\n\n"
          fi
          
          if [[ "$new_features" == "" && "$fixes" == "" && "$improvements" == "" && "$others" == "" ]]; then
            changelog="${changelog}*æœ¬æ¬¡ç‰ˆæœ¬æ›´æ–°æœªåŒ…å«ç¬¦åˆæ ¼å¼è¦æ±‚çš„æäº¤ä¿¡æ¯*\n"
          fi
          
          # è¾“å‡ºæ›´æ–°æ—¥å¿—ç»™åç»­æ­¥éª¤ä½¿ç”¨
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo -e "$changelog" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆä¸‹è½½é“¾æ¥è¡¨æ ¼å’Œè¯´æ˜
        id: generate_table
        run: |
          # æ ¹æ®ç‰ˆæœ¬ç±»å‹è®¾ç½®ä¸åŒçš„æ ‡é¢˜
          if [[ "${{ needs.get-version.outputs.version_type }}" == "Development Version" ]]; then
            echo "# ğŸš§ GestroKey æœ€æ–°å¼€å‘æ„å»º (æœªå‘å¸ƒç‰ˆæœ¬)" > release_description.md
            echo "" >> release_description.md
            echo "**ç‰ˆæœ¬å·:** ${{ needs.get-version.outputs.version }}" >> release_description.md
            echo "**è­¦å‘Š:** æ­¤ç‰ˆæœ¬ä¸ºè‡ªåŠ¨æ„å»ºçš„æœ€æ–°å¼€å‘ç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«ä¸ç¨³å®šåŠŸèƒ½å’Œå·²çŸ¥é—®é¢˜" >> release_description.md
          else
            echo "# GestroKey ${{ needs.get-version.outputs.version }} ${{ needs.get-version.outputs.version_type }}" > release_description.md
          fi
          
          echo "" >> release_description.md
          echo "## ä¸‹è½½é“¾æ¥" >> release_description.md
          echo "" >> release_description.md
          echo "| æ“ä½œç³»ç»Ÿ | å•æ–‡ä»¶ç‰ˆ | ä¾¿æºç‰ˆ |" >> release_description.md
          echo "|---------|---------|-------|" >> release_description.md
          echo "| Windows | [ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶](${{ needs.get-version.outputs.repo_url }}/releases/download/${{ needs.get-version.outputs.release_name }}/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Standalone.exe) | [ZIPå‹ç¼©åŒ…](${{ needs.get-version.outputs.repo_url }}/releases/download/${{ needs.get-version.outputs.release_name }}/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable.zip) |" >> release_description.md
          echo "| macOS   | [ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶](${{ needs.get-version.outputs.repo_url }}/releases/download/${{ needs.get-version.outputs.release_name }}/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone) | [ZIPå‹ç¼©åŒ…](${{ needs.get-version.outputs.repo_url }}/releases/download/${{ needs.get-version.outputs.release_name }}/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable.zip) |" >> release_description.md
          echo "| Linux   | [ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶](${{ needs.get-version.outputs.repo_url }}/releases/download/${{ needs.get-version.outputs.release_name }}/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Standalone) | [TAR.GZå‹ç¼©åŒ…](${{ needs.get-version.outputs.repo_url }}/releases/download/${{ needs.get-version.outputs.release_name }}/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable.tar.gz) |" >> release_description.md
          echo "" >> release_description.md
          
          # æ·»åŠ ç³»ç»Ÿè¦æ±‚
          echo "## ç³»ç»Ÿè¦æ±‚" >> release_description.md
          echo "" >> release_description.md
          echo "- **Windows**: Windows 10/11 64ä½" >> release_description.md
          echo "- **macOS**: macOS 11.0+ (Big SuråŠæ›´é«˜ç‰ˆæœ¬)" >> release_description.md
          echo "- **Linux**: ä¸»æµæ¡Œé¢å‘è¡Œç‰ˆ (Ubuntu 20.04+, Fedora 36+, Debian 11+)" >> release_description.md
          echo "" >> release_description.md
          
          # æ·»åŠ æ›´æ–°æ—¥å¿—
          echo -e "${{ steps.generate_changelog.outputs.CHANGELOG }}" >> release_description.md
          
          # æ·»åŠ æ„å»ºä¿¡æ¯
          echo "" >> release_description.md
          echo "---" >> release_description.md
          echo "" >> release_description.md
          echo "æ­¤ç‰ˆæœ¬ç”±GitHub Actionsè‡ªåŠ¨æ„å»ºäº $(date '+%Y-%m-%d %H:%M:%S %Z')" >> release_description.md
          
          # è¾“å‡ºå®Œæ•´å†…å®¹ç»™åç»­æ­¥éª¤ä½¿ç”¨
          echo "DESCRIPTION<<EOF" >> $GITHUB_OUTPUT
          cat release_description.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
      - name: æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
        id: check_tag
        uses: mukunku/tag-exists-action@v1.4.0
        with:
          tag: ${{ needs.get-version.outputs.release_name }}

      # åˆ é™¤å·²å­˜åœ¨çš„releaseå’Œæ ‡ç­¾
      - name: åˆ é™¤å·²å­˜åœ¨çš„releaseå’Œæ ‡ç­¾
        if: steps.check_tag.outputs.exists == 'true'
        run: |
          echo "ç§»é™¤å·²å­˜åœ¨çš„æ ‡ç­¾: ${{ needs.get-version.outputs.release_name }}"
          
          # ä½¿ç”¨GitHub CLIåˆ é™¤releaseå’Œæ ‡ç­¾
          gh release delete ${{ needs.get-version.outputs.release_name }} --yes || echo "Releaseä¸å­˜åœ¨æˆ–æ— æ³•åˆ é™¤"
          
          # åˆ é™¤è¿œç¨‹æ ‡ç­¾
          git tag -d ${{ needs.get-version.outputs.release_name }} || echo "æœ¬åœ°æ ‡ç­¾ä¸å­˜åœ¨"
          git push --delete origin ${{ needs.get-version.outputs.release_name }} || echo "è¿œç¨‹æ ‡ç­¾ä¸å­˜åœ¨æˆ–æ— æ³•åˆ é™¤"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      # å½“å‘å¸ƒæ­£å¼ç‰ˆæˆ–é¢„è§ˆç‰ˆæ—¶åˆ é™¤latestæ ‡ç­¾
      - name: åˆ é™¤latestæ ‡ç­¾
        if: needs.get-version.outputs.version_type != 'Development Version'
        run: |
          echo "å‘å¸ƒæ­£å¼ç‰ˆæˆ–é¢„è§ˆç‰ˆï¼Œåˆ é™¤latestæ ‡ç­¾"
          
          # æ£€æŸ¥latestæ ‡ç­¾æ˜¯å¦å­˜åœ¨
          if git ls-remote --tags origin | grep -q "refs/tags/999.999.999-latest"; then
            # åˆ é™¤GitHub Release
            gh release delete 999.999.999-latest --yes || echo "Release latestä¸å­˜åœ¨æˆ–æ— æ³•åˆ é™¤"
            
            # åˆ é™¤è¿œç¨‹æ ‡ç­¾
            git push --delete origin 999.999.999-latest || echo "è¿œç¨‹æ ‡ç­¾latestä¸å­˜åœ¨æˆ–æ— æ³•åˆ é™¤"
          else
            # å…¼å®¹æ€§æ£€æŸ¥ï¼šä¹Ÿå°è¯•åˆ é™¤æ—§çš„latestæ ‡ç­¾
            if git ls-remote --tags origin | grep -q "refs/tags/latest"; then
              gh release delete latest --yes || echo "Release latestä¸å­˜åœ¨æˆ–æ— æ³•åˆ é™¤"
              git push --delete origin latest || echo "è¿œç¨‹æ ‡ç­¾latestä¸å­˜åœ¨æˆ–æ— æ³•åˆ é™¤"
            else
              echo "æ ‡ç­¾latestä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤"
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾
      - name: åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾
        run: |
          # åˆ›å»ºæ ‡ç­¾
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          echo "åˆ›å»ºæ ‡ç­¾: ${{ needs.get-version.outputs.release_name }}"
          git tag -a ${{ needs.get-version.outputs.release_name }} -m "Release ${{ needs.get-version.outputs.release_name }}"
          
          # æ¨é€æ ‡ç­¾
          git push origin ${{ needs.get-version.outputs.release_name }}

      # åˆ›å»ºRelease
      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ needs.get-version.outputs.release_name }}
          tag_name: ${{ needs.get-version.outputs.release_name }}
          body: ${{ steps.generate_table.outputs.DESCRIPTION }}
          prerelease: ${{ needs.get-version.outputs.is_prerelease }}
          files: artifacts/*

  # ä»£ç è´¨é‡æ£€æŸ¥ä»»åŠ¡
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…è´¨é‡æ£€æŸ¥å·¥å…·
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint black isort
      
      - name: è¿è¡Œflake8æ£€æŸ¥
        run: |
          flake8 src tests --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 src tests --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name: è¿è¡Œpylintæ£€æŸ¥
        run: |
          pylint --disable=all --enable=unused-import,unused-variable,unused-argument src
          
      - name: æ£€æŸ¥ä»£ç æ ¼å¼
        run: |
          black --check src tests
          isort --check-only --profile black src tests
          
      - name: æ€»ç»“ä»£ç è´¨é‡æ£€æŸ¥
        run: |
          echo "ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"

  # ä¾èµ–å®‰å…¨æ‰«æä»»åŠ¡
  security-scan:
    name: ä¾èµ–å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…å®‰å…¨æ‰«æå·¥å…·
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit
      
      - name: æ‰«æä¾èµ–æ¼æ´
        run: |
          safety check -r requirements.txt --full-report || echo "å®‰å…¨æ£€æŸ¥å‘ç°æ½œåœ¨é—®é¢˜ï¼Œä½†å…è®¸ç»§ç»­"
      
      - name: è¿è¡Œä»£ç å®‰å…¨æ‰«æ
        run: |
          bandit -r src -f txt -o bandit_results.txt || echo "ä»£ç å®‰å…¨æ‰«æå‘ç°æ½œåœ¨é—®é¢˜ï¼Œä½†å…è®¸ç»§ç»­"
          
      - name: ä¸Šä¼ æ‰«æç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            bandit_results.txt
          retention-days: 7
          
      - name: æ€»ç»“å®‰å…¨æ‰«æ
        run: |
          echo "å®‰å…¨æ‰«æå®Œæˆï¼Œè¯¦ç»†ç»“æœè¯·æŸ¥çœ‹æ„å»ºäº§ç‰©"