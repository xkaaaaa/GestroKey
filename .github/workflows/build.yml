name: GestroKey CI/CD

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'è·³è¿‡å®é™…ç¼–è¯‘è¿‡ç¨‹ (true/false)'
        required: false
        default: 'false'
        type: boolean

# ä¸ºå·¥ä½œæµæ·»åŠ æƒé™
permissions:
  contents: write
  packages: read
  issues: read
  pull-requests: read
  actions: write

jobs:
  # æ£€æŸ¥æäº¤å†…å®¹ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰“åŒ…
  check-changes:
    name: æ£€æŸ¥ä»£ç å˜æ›´
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check_manual.outputs.changed == 'true' || steps.check_py_changes.outputs.changed == 'true' }}
    
    steps:
      - name: æ‰‹åŠ¨è§¦å‘æ£€æŸ¥
        id: check_manual
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "æ˜¯æ‰‹åŠ¨è§¦å‘çš„å·¥ä½œæµï¼Œå°†æ‰§è¡Œå®Œæ•´æµç¨‹"
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: æ£€å‡ºä»£ç 
        if: steps.check_manual.outputs.changed != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´çš„æäº¤å†å²
      
      - name: è·å–ä¸Šæ¬¡æ‰“åŒ…æ ‡ç­¾
        if: steps.check_manual.outputs.changed != 'true'
        id: last_tag
        run: |
          # è·å–æ‰€æœ‰æ ‡ç­¾å¹¶æŒ‰æ—¶é—´æ’åº
          tags=$(git tag --sort=-creatordate)
          latest_tag=$(echo "$tags" | grep -v "^latest$" | head -n 1)
          
          if [ -z "$latest_tag" ]; then
            # å¦‚æœæ²¡æœ‰æ ‡ç­¾ï¼Œåˆ™è®¾ç½®ä¸€ä¸ªåˆå§‹çš„SHA
            echo "LAST_TAG=$(git rev-list --max-parents=0 HEAD)" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ‰¾åˆ°ä¹‹å‰çš„æ ‡ç­¾ï¼Œå°†ä»é¦–æ¬¡æäº¤å¼€å§‹æ£€æŸ¥"
          else
            echo "LAST_TAG=$latest_tag" >> $GITHUB_OUTPUT
            echo "ä½¿ç”¨æœ€è¿‘çš„æ ‡ç­¾: $latest_tag"
          fi
      
      - name: æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†.pyæ–‡ä»¶
        if: steps.check_manual.outputs.changed != 'true'
        id: check_py_changes
        run: |
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘çš„å·¥ä½œæµï¼Œç›´æ¥è¿”å›true
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼Œç»§ç»­æ„å»º"
            echo "changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # è·å–ä¸Šæ¬¡å‘å¸ƒåä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨
          files_changed=$(git diff --name-only ${{ steps.last_tag.outputs.LAST_TAG }}..HEAD)
          
          # æ£€æŸ¥æ˜¯å¦æœ‰.pyæ–‡ä»¶è¢«ä¿®æ”¹
          py_changed=false
          while IFS= read -r file; do
            if [[ "$file" == *.py ]]; then
              py_changed=true
              echo "å‘ç°ä¿®æ”¹çš„Pythonæ–‡ä»¶: $file"
              break
            fi
          done <<< "$files_changed"
          
          # å¦‚æœå·¥ä½œæµæ˜¯æ‰‹åŠ¨è§¦å‘çš„ï¼Œå¹¶ä¸”ä¸æ˜¯è¦æ±‚è·³è¿‡æ„å»ºï¼Œé‚£ä¹ˆç»§ç»­æ„å»º
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.skip_build }}" != "true" ]]; then
            echo "æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼Œç»§ç»­æ„å»º"
            py_changed=true
          fi
          
          echo "changed=$py_changed" >> $GITHUB_OUTPUT
          
          if [ "$py_changed" == "true" ]; then
            echo "æ£€æµ‹åˆ°Pythonæ–‡ä»¶å˜æ›´æˆ–æ‰‹åŠ¨è§¦å‘ï¼Œå°†æ‰§è¡Œæ‰“åŒ…æµç¨‹"
          else
            echo "æœªæ£€æµ‹åˆ°Pythonæ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æ‰“åŒ…æµç¨‹"
          fi

  # è¯»å–ç‰ˆæœ¬ä¿¡æ¯ä½œä¸ºç‹¬ç«‹ä»»åŠ¡
  get-version:
    name: è¯»å–ç‰ˆæœ¬ä¿¡æ¯
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    outputs:
      version: ${{ steps.version_info.outputs.VERSION }}
      version_type: ${{ steps.version_info.outputs.VERSION_TYPE }}
      is_prerelease: ${{ steps.version_info.outputs.IS_PRERELEASE }}
      release_name: ${{ steps.version_info.outputs.RELEASE_NAME }}
      repo_url: ${{ steps.version_info.outputs.REPO_URL }}
      enable_packaging: ${{ steps.package_config.outputs.ENABLE_PACKAGING }}
      package_windows: ${{ steps.package_config.outputs.PACKAGE_WINDOWS }}
      package_macos: ${{ steps.package_config.outputs.PACKAGE_MACOS }}
      package_linux: ${{ steps.package_config.outputs.PACKAGE_LINUX }}
      package_standalone: ${{ steps.package_config.outputs.PACKAGE_STANDALONE }}
      package_portable: ${{ steps.package_config.outputs.PACKAGE_PORTABLE }}
      packager_windows: ${{ steps.package_config.outputs.PACKAGER_WINDOWS }}
      packager_macos: ${{ steps.package_config.outputs.PACKAGER_MACOS }}
      packager_linux: ${{ steps.package_config.outputs.PACKAGER_LINUX }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: è¯»å–ç‰ˆæœ¬ä¿¡æ¯
        id: version_info
        run: |
          # åˆ›å»ºä¸´æ—¶è„šæœ¬è¯»å–ç‰ˆæœ¬ä¿¡æ¯
          cat << EOF > temp_version_script.py
          import sys
          from src.version import VERSION, CURRENT_VERSION_TYPE, VERSION_TYPE_RELEASE, VERSION_TYPE_PREVIEW, VERSION_TYPE_DEVELOPMENT, REPO_URL
          
          # è¾“å‡ºç‰ˆæœ¬å·
          print(VERSION)
          
          # è¾“å‡ºç‰ˆæœ¬ç±»å‹ï¼ˆè‹±æ–‡ï¼‰
          if CURRENT_VERSION_TYPE == "æœªå‘å¸ƒç‰ˆ":
              print("development")
          elif CURRENT_VERSION_TYPE == "é¢„è§ˆç‰ˆ":
              print("preview")
          elif CURRENT_VERSION_TYPE == "æ­£å¼ç‰ˆ":
              print("release")
          else:
              print("unknown")
              
          # è¾“å‡ºä»“åº“URL
          print(REPO_URL)
          EOF
          
          # æ‰§è¡Œè„šæœ¬å¹¶è¯»å–è¾“å‡º
          IFS=$'\n' read -d '' -ra outputs < <(python temp_version_script.py && printf '\0')
          version="${outputs[0]}"
          version_type="${outputs[1]}"
          repo_url="${outputs[2]}"
          
          # åˆ é™¤ä¸´æ—¶è„šæœ¬
          rm temp_version_script.py
          
          # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "VERSION=$version" >> $GITHUB_OUTPUT
          echo "REPO_URL=$repo_url" >> $GITHUB_OUTPUT
          
          # æ ¹æ®è‹±æ–‡ç‰ˆæœ¬ç±»å‹åˆ¤æ–­è¦åˆ›å»ºçš„releaseåç§°å’Œæ˜¯å¦ä¸ºé¢„è§ˆç‰ˆ
          if [ "$version_type" = "development" ]; then
            echo "VERSION_TYPE=Development Version" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=latest" >> $GITHUB_OUTPUT
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
          elif [ "$version_type" = "preview" ]; then
            echo "VERSION_TYPE=Preview Version" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=$version-preview" >> $GITHUB_OUTPUT
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
          else
            echo "VERSION_TYPE=Release Version" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=$version" >> $GITHUB_OUTPUT
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
          fi

      - name: è¯»å–æ‰“åŒ…é…ç½®
        id: package_config
        run: |
          # åˆ›å»ºä¸´æ—¶è„šæœ¬è¯»å–æ‰“åŒ…é…ç½®
          cat << EOF > temp_package_script.py
          from src.version import ENABLE_PACKAGING, PACKAGE_WINDOWS, PACKAGE_MACOS, PACKAGE_LINUX
          from src.version import PACKAGE_STANDALONE, PACKAGE_PORTABLE
          from src.version import PACKAGER_WINDOWS, PACKAGER_MACOS, PACKAGER_LINUX
          
          # è¾“å‡ºæ‰“åŒ…æ§åˆ¶é€‰é¡¹
          print("true" if ENABLE_PACKAGING else "false")
          print("true" if PACKAGE_WINDOWS else "false")
          print("true" if PACKAGE_MACOS else "false")
          print("true" if PACKAGE_LINUX else "false")
          print("true" if PACKAGE_STANDALONE else "false")
          print("true" if PACKAGE_PORTABLE else "false")
          print(PACKAGER_WINDOWS)
          print(PACKAGER_MACOS)
          print(PACKAGER_LINUX)
          EOF
          
          # æ‰§è¡Œè„šæœ¬å¹¶è¯»å–è¾“å‡º
          IFS=$'\n' read -d '' -ra outputs < <(python temp_package_script.py && printf '\0')
          
          # è¾“å‡ºé…ç½®ä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "ENABLE_PACKAGING=${outputs[0]}" >> $GITHUB_OUTPUT
          echo "PACKAGE_WINDOWS=${outputs[1]}" >> $GITHUB_OUTPUT
          echo "PACKAGE_MACOS=${outputs[2]}" >> $GITHUB_OUTPUT
          echo "PACKAGE_LINUX=${outputs[3]}" >> $GITHUB_OUTPUT
          echo "PACKAGE_STANDALONE=${outputs[4]}" >> $GITHUB_OUTPUT
          echo "PACKAGE_PORTABLE=${outputs[5]}" >> $GITHUB_OUTPUT
          echo "PACKAGER_WINDOWS=${outputs[6]}" >> $GITHUB_OUTPUT
          echo "PACKAGER_MACOS=${outputs[7]}" >> $GITHUB_OUTPUT
          echo "PACKAGER_LINUX=${outputs[8]}" >> $GITHUB_OUTPUT
          
          # åˆ é™¤ä¸´æ—¶è„šæœ¬
          rm temp_package_script.py

  # ä½¿ç”¨çŸ©é˜µæ„å»ºä¸åŒå¹³å°å’Œæ ¼å¼çš„åŒ…
  build:
    name: æ„å»º ${{ matrix.os }} ${{ matrix.package-type }}
    runs-on: ${{ matrix.os }}
    needs: get-version
    if: needs.get-version.outputs.enable_packaging == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windowsæ„å»º
          - os: windows-latest
            package-type: standalone
            if: ${{ needs.get-version.outputs.package_windows == 'true' && needs.get-version.outputs.package_standalone == 'true' }}
          - os: windows-latest
            package-type: portable
            if: ${{ needs.get-version.outputs.package_windows == 'true' && needs.get-version.outputs.package_portable == 'true' }}
          # Linuxæ„å»º
          - os: ubuntu-latest
            package-type: standalone
            if: ${{ needs.get-version.outputs.package_linux == 'true' && needs.get-version.outputs.package_standalone == 'true' }}
          - os: ubuntu-latest
            package-type: portable
            if: ${{ needs.get-version.outputs.package_linux == 'true' && needs.get-version.outputs.package_portable == 'true' }}
          # macOSæ„å»º
          - os: macos-latest
            package-type: standalone
            if: ${{ needs.get-version.outputs.package_macos == 'true' && needs.get-version.outputs.package_standalone == 'true' }}
          - os: macos-latest
            package-type: portable
            if: ${{ needs.get-version.outputs.package_macos == 'true' && needs.get-version.outputs.package_portable == 'true' }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: macOS - è®¾ç½®QT_APIä¸ºpyside6
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          # åœ¨macOSä¸Šå¼ºåˆ¶ä½¿ç”¨pyside6
          python -c "
          import sys
          import os
          sys.path.append('src')
          
          # è¯»å–version.pyæ–‡ä»¶
          with open('src/version.py', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # å°†QT_APIæ›¿æ¢ä¸ºpyside6
          if 'QT_API = \"pyqt6\"' in content:
              content = content.replace('QT_API = \"pyqt6\"', 'QT_API = \"pyside6\"')
          elif 'QT_API = \"pyqt5\"' in content:
              content = content.replace('QT_API = \"pyqt5\"', 'QT_API = \"pyside6\"')
          elif 'QT_API = \"pyside2\"' in content:
              content = content.replace('QT_API = \"pyside2\"', 'QT_API = \"pyside6\"')
          
          # å†™å›æ–‡ä»¶
          with open('src/version.py', 'w', encoding='utf-8') as f:
              f.write(content)
          
          print('macOSç¯å¢ƒå·²è®¾ç½®QT_APIä¸ºpyside6')
          "

      - name: å®‰è£…ä¾èµ–
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install nuitka
          pip install -r requirements.txt
          
          # æ ¹æ® version.py ä¸­çš„ QT_API é…ç½®å®‰è£…å¯¹åº”çš„ Qt åç«¯
          QT_API=$(python -c "import sys; sys.path.append('src'); from version import QT_API; print(QT_API)")
          echo "æ£€æµ‹åˆ° Qt API: $QT_API"
          
          if [ "$QT_API" = "pyqt5" ]; then
            pip install "PyQt5>=5.15.0" "PyQt5-sip>=12.8.0"
          elif [ "$QT_API" = "pyside6" ]; then
            pip install "PySide6>=6.5.0"
          elif [ "$QT_API" = "pyside2" ]; then
            pip install "PySide2>=5.15.0"
          fi
          
      # ä¸ºmacOSå®‰è£…PyInstaller
      - name: macOS - å®‰è£…PyInstaller
        if: matrix.os == 'macos-latest'
        run: |
          pip install pyinstaller
          
      # Windowsç‰¹å®šå®‰è£…
      - name: Windows - å®‰è£…å·¥å…·
        if: matrix.os == 'windows-latest'
        run: |
          choco install imagemagick -y

      # macOSç‰¹å®šå®‰è£…
      - name: macOS - å®‰è£…å·¥å…·
        if: matrix.os == 'macos-latest'
        run: |
          brew install imagemagick

      # Linuxç‰¹å®šå®‰è£…
      - name: Linux - å®‰è£…å·¥å…·
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick fakeroot



      # æ„å»ºå¤šæ–‡ä»¶ä¾¿æºç‰ˆ - Windows (Nuitka)
      - name: æ„å»ºä¾¿æºç‰ˆ - Windows (Nuitka)
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build != 'true' && matrix.os == 'windows-latest' && needs.get-version.outputs.packager_windows == 'nuitka'
        shell: pwsh
        run: |
          $QT_API = python -c "import sys; sys.path.append('src'); from version import QT_API; print(QT_API)"
          Write-Host "æ£€æµ‹åˆ° Qt API: $QT_API"
          python -m nuitka --standalone --enable-plugin=$QT_API --include-data-dir=src/assets=assets --include-data-files=src/ui/settings/default_settings.json=ui/settings/default_settings.json --include-data-files=src/ui/gestures/default_gestures.json=ui/gestures/default_gestures.json --windows-icon-from-ico=src/assets/images/icons/icon.ico --output-dir=dist --assume-yes-for-downloads src/main.py
          mkdir -Force -Path "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable"
          Copy-Item -Path dist/main.dist/* -Destination "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable/" -Recurse
          Compress-Archive -Path "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable/*" -DestinationPath "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable.zip" -Force

      # æ„å»ºå¤šæ–‡ä»¶ä¾¿æºç‰ˆ - Windows (PyInstaller)
      - name: æ„å»ºä¾¿æºç‰ˆ - Windows (PyInstaller)
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build != 'true' && matrix.os == 'windows-latest' && needs.get-version.outputs.packager_windows == 'pyinstaller'
        shell: pwsh
        run: |
          pip install pyinstaller
          pyinstaller --name=GestroKey --windowed --noconfirm --add-data="src/assets;assets" --add-data="src/ui/settings/default_settings.json;ui/settings" --add-data="src/ui/gestures/default_gestures.json;ui/gestures" --icon=src/assets/images/icons/icon.ico src/main.py
          mkdir -Force -Path "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable"
          Copy-Item -Path dist/GestroKey/* -Destination "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable/" -Recurse
          Compress-Archive -Path "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable/*" -DestinationPath "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable.zip" -Force

      # æ„å»ºå¤šæ–‡ä»¶ä¾¿æºç‰ˆ - Linux (Nuitka)
      - name: æ„å»ºä¾¿æºç‰ˆ - Linux (Nuitka)
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build != 'true' && matrix.os == 'ubuntu-latest' && needs.get-version.outputs.packager_linux == 'nuitka'
        shell: bash
        run: |
          QT_API=$(python -c "import sys; sys.path.append('src'); from version import QT_API; print(QT_API)")
          echo "æ£€æµ‹åˆ° Qt API: $QT_API"
          python -m nuitka --standalone --enable-plugin=$QT_API --include-data-dir=src/assets=assets --include-data-files=src/ui/settings/default_settings.json=ui/settings/default_settings.json --include-data-files=src/ui/gestures/default_gestures.json=ui/gestures/default_gestures.json --output-dir=dist --assume-yes-for-downloads src/main.py
          mkdir -p "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable"
          cp -r dist/main.dist/* "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable/"
          cd dist && tar -czvf "GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable.tar.gz" "GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable"

      # æ„å»ºå¤šæ–‡ä»¶ä¾¿æºç‰ˆ - Linux (PyInstaller)
      - name: æ„å»ºä¾¿æºç‰ˆ - Linux (PyInstaller)
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build != 'true' && matrix.os == 'ubuntu-latest' && needs.get-version.outputs.packager_linux == 'pyinstaller'
        shell: bash
        run: |
          pip install pyinstaller
          pyinstaller --name=GestroKey --windowed --noconfirm --add-data="src/assets:assets" --add-data="src/ui/settings/default_settings.json:ui/settings" --add-data="src/ui/gestures/default_gestures.json:ui/gestures" src/main.py
          mkdir -p "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable"
          cp -r dist/GestroKey/* "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable/"
          cd dist && tar -czvf "GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable.tar.gz" "GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable"

      # æ„å»ºå¤šæ–‡ä»¶ä¾¿æºç‰ˆ - macOS (Nuitka)
      - name: æ„å»ºä¾¿æºç‰ˆ - macOS (Nuitka)
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build != 'true' && matrix.os == 'macos-latest' && needs.get-version.outputs.packager_macos == 'nuitka'
        shell: bash
        run: |
          QT_API=$(python -c "import sys; sys.path.append('src'); from version import QT_API; print(QT_API)")
          echo "æ£€æµ‹åˆ° Qt API: $QT_API"
          python -m nuitka --mode=app --enable-plugin=$QT_API --include-data-dir=src/assets=assets --include-data-files=src/ui/settings/default_settings.json=ui/settings/default_settings.json --include-data-files=src/ui/gestures/default_gestures.json=ui/gestures/default_gestures.json --output-dir=dist --assume-yes-for-downloads src/main.py
          mkdir -p "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable"
          cp -r dist/main.app "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable/GestroKey.app"
          cd dist && zip -r "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable.zip" "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable"

      # æ„å»ºå¤šæ–‡ä»¶ä¾¿æºç‰ˆ - macOS (ä½¿ç”¨PyInstaller)
      - name: æ„å»ºä¾¿æºç‰ˆ - macOS (PyInstaller)
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build != 'true' && matrix.os == 'macos-latest' && needs.get-version.outputs.packager_macos == 'pyinstaller'
        shell: bash
        run: |
          # åˆ›å»ºspecæ–‡ä»¶
          cat > GestroKey.spec << EOF
          # -*- mode: python ; coding: utf-8 -*-
          
          a = Analysis(
              ['src/main.py'],
              pathex=[],
              binaries=[],
              datas=[
                  ('src/assets', 'assets'),
                  ('src/ui/settings/default_settings.json', 'ui/settings'),
                  ('src/ui/gestures/default_gestures.json', 'ui/gestures')
              ],
              hiddenimports=[],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              noarchive=False,
          )
          
          pyz = PYZ(a.pure)
          
          exe = EXE(
              pyz,
              a.scripts,
              [],
              exclude_binaries=True,
              name='GestroKey',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=True,
              console=False,
              disable_windowed_traceback=False,
              argv_emulation=True,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
              icon='src/assets/images/icons/icon.icns',
          )
          
          coll = COLLECT(
              exe,
              a.binaries,
              a.datas,
              strip=False,
              upx=True,
              upx_exclude=[],
              name='GestroKey',
          )
          
          app = BUNDLE(
              coll,
              name='GestroKey.app',
              icon='src/assets/images/icons/icon.icns',
              bundle_identifier=None,
              info_plist={
                  'NSHighResolutionCapable': 'True',
                  'CFBundleShortVersionString': '${{ needs.get-version.outputs.version }}',
                  'CFBundleVersion': '${{ needs.get-version.outputs.version }}',
                  'CFBundleName': 'GestroKey',
                  'CFBundleDisplayName': 'GestroKey',
                  'CFBundleExecutable': 'GestroKey',
              },
          )
          EOF
          
          # ä½¿ç”¨PyInstalleræ„å»º
          pyinstaller GestroKey.spec
          
          # æ‰“åŒ…
          mkdir -p "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable"
          cp -r dist/GestroKey.app "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable/"
          cd dist && zip -r "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable.zip" "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable"

      # æ„å»ºå•æ–‡ä»¶ç‰ˆæœ¬ - Windows
      - name: æ„å»ºå•æ–‡ä»¶ç‰ˆ - Windows (Nuitka)
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build != 'true' && matrix.os == 'windows-latest' && needs.get-version.outputs.packager_windows == 'nuitka'
        shell: pwsh
        run: |
          $QT_API = python -c "import sys; sys.path.append('src'); from version import QT_API; print(QT_API)"
          Write-Host "æ£€æµ‹åˆ° Qt API: $QT_API"
          python -m nuitka --onefile --enable-plugin=$QT_API --include-data-dir=src/assets=assets --include-data-files=src/ui/settings/default_settings.json=ui/settings/default_settings.json --include-data-files=src/ui/gestures/default_gestures.json=ui/gestures/default_gestures.json --windows-icon-from-ico=src/assets/images/icons/icon.ico --output-dir=dist --assume-yes-for-downloads src/main.py
          Move-Item -Path dist/main.exe -Destination "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Standalone.exe"

      # æ„å»ºå•æ–‡ä»¶ç‰ˆæœ¬ - Windows (PyInstaller)
      - name: æ„å»ºå•æ–‡ä»¶ç‰ˆ - Windows (PyInstaller)
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build != 'true' && matrix.os == 'windows-latest' && needs.get-version.outputs.packager_windows == 'pyinstaller'
        shell: pwsh
        run: |
          pip install pyinstaller
          pyinstaller --name=GestroKey --onefile --windowed --noconfirm --add-data="src/assets;assets" --add-data="src/ui/settings/default_settings.json;ui/settings" --add-data="src/ui/gestures/default_gestures.json;ui/gestures" --icon=src/assets/images/icons/icon.ico src/main.py
          Move-Item -Path dist/GestroKey.exe -Destination "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Standalone.exe"

      # æ„å»ºå•æ–‡ä»¶ç‰ˆæœ¬ - Linux
      - name: æ„å»ºå•æ–‡ä»¶ç‰ˆ - Linux (Nuitka)
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build != 'true' && matrix.os == 'ubuntu-latest' && needs.get-version.outputs.packager_linux == 'nuitka'
        shell: bash
        run: |
          QT_API=$(python -c "import sys; sys.path.append('src'); from version import QT_API; print(QT_API)")
          echo "æ£€æµ‹åˆ° Qt API: $QT_API"
          python -m nuitka --onefile --enable-plugin=$QT_API --include-data-dir=src/assets=assets --include-data-files=src/ui/settings/default_settings.json=ui/settings/default_settings.json --include-data-files=src/ui/gestures/default_gestures.json=ui/gestures/default_gestures.json --output-dir=dist --assume-yes-for-downloads src/main.py
          mv dist/main.bin "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Standalone"
          chmod +x "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Standalone"

      # æ„å»ºå•æ–‡ä»¶ç‰ˆæœ¬ - Linux (PyInstaller)
      - name: æ„å»ºå•æ–‡ä»¶ç‰ˆ - Linux (PyInstaller)
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build != 'true' && matrix.os == 'ubuntu-latest' && needs.get-version.outputs.packager_linux == 'pyinstaller'
        shell: bash
        run: |
          pip install pyinstaller
          pyinstaller --name=GestroKey --onefile --windowed --noconfirm --add-data="src/assets:assets" --add-data="src/ui/settings/default_settings.json:ui/settings" --add-data="src/ui/gestures/default_gestures.json:ui/gestures" src/main.py
          mv dist/GestroKey "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Standalone"
          chmod +x "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Standalone"

      # æ„å»ºå•æ–‡ä»¶ç‰ˆæœ¬ - macOS (Nuitka)
      - name: æ„å»ºå•æ–‡ä»¶ç‰ˆ - macOS (Nuitka)
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build != 'true' && matrix.os == 'macos-latest' && needs.get-version.outputs.packager_macos == 'nuitka'
        shell: bash
        run: |
          QT_API=$(python -c "import sys; sys.path.append('src'); from version import QT_API; print(QT_API)")
          echo "æ£€æµ‹åˆ° Qt API: $QT_API"
          python -m nuitka --mode=app --enable-plugin=$QT_API --include-data-dir=src/assets=assets --include-data-files=src/ui/settings/default_settings.json=ui/settings/default_settings.json --include-data-files=src/ui/gestures/default_gestures.json=ui/gestures/default_gestures.json --output-dir=dist --assume-yes-for-downloads src/main.py
          mkdir -p "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone"
          cp -r dist/main.app "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone/GestroKey.app"
          cd dist && zip -r "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone.zip" "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone"

      # æ„å»ºå•æ–‡ä»¶ç‰ˆæœ¬ - macOS (ä½¿ç”¨PyInstaller)
      - name: æ„å»ºå•æ–‡ä»¶ç‰ˆ - macOS (PyInstaller)
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build != 'true' && matrix.os == 'macos-latest' && needs.get-version.outputs.packager_macos == 'pyinstaller'
        shell: bash
        run: |
          # åˆ›å»ºspecæ–‡ä»¶
          cat > GestroKey_onefile.spec << EOF
          # -*- mode: python ; coding: utf-8 -*-
          
          a = Analysis(
              ['src/main.py'],
              pathex=[],
              binaries=[],
              datas=[
                  ('src/assets', 'assets'),
                  ('src/ui/settings/default_settings.json', 'ui/settings'),
                  ('src/ui/gestures/default_gestures.json', 'ui/gestures')
              ],
              hiddenimports=[],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              noarchive=False,
          )
          
          pyz = PYZ(a.pure)
          
          exe = EXE(
              pyz,
              a.scripts,
              a.binaries,
              a.datas,
              [],
              name='GestroKey',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=True,
              upx_exclude=[],
              runtime_tmpdir=None,
              console=False,
              disable_windowed_traceback=False,
              argv_emulation=True,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
              icon='src/assets/images/icons/icon.icns',
          )
          
          app = BUNDLE(
              exe,
              name='GestroKey.app',
              icon='src/assets/images/icons/icon.icns',
              bundle_identifier=None,
              info_plist={
                  'NSHighResolutionCapable': 'True',
                  'CFBundleShortVersionString': '${{ needs.get-version.outputs.version }}',
                  'CFBundleVersion': '${{ needs.get-version.outputs.version }}',
                  'CFBundleName': 'GestroKey',
                  'CFBundleDisplayName': 'GestroKey',
                  'CFBundleExecutable': 'GestroKey',
              },
          )
          EOF
          
          # ä½¿ç”¨PyInstalleræ„å»º
          pyinstaller GestroKey_onefile.spec
          
          # æ‰“åŒ…
          mkdir -p "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone"
          cp -r dist/GestroKey.app "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone/GestroKey.app"
          cd dist && zip -r "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone.zip" "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone"

      # æ¨¡æ‹Ÿæ„å»ºä¾¿æºç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Windows
      - name: æ¨¡æ‹Ÿæ„å»ºä¾¿æºç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Windows
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build == 'true' && matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          echo "è·³è¿‡ç¼–è¯‘è¿‡ç¨‹ï¼Œåˆ›å»ºWindowsä¾¿æºç‰ˆè™šæ‹ŸåŒ…..."
          mkdir -Force -Path "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable"
          "æ¨¡æ‹Ÿæ„å»º" | Out-File -FilePath "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable/README.txt"
          Compress-Archive -Path "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable/*" -DestinationPath "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable.zip" -Force

      # æ¨¡æ‹Ÿæ„å»ºä¾¿æºç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Linux
      - name: æ¨¡æ‹Ÿæ„å»ºä¾¿æºç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Linux
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build == 'true' && matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          echo "è·³è¿‡ç¼–è¯‘è¿‡ç¨‹ï¼Œåˆ›å»ºLinuxä¾¿æºç‰ˆè™šæ‹ŸåŒ…..."
          mkdir -p "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable"
          echo "æ¨¡æ‹Ÿæ„å»º" > "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable/README.txt"
          cd dist && tar -czvf "GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable.tar.gz" "GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable"

      # æ¨¡æ‹Ÿæ„å»ºä¾¿æºç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- macOS
      - name: æ¨¡æ‹Ÿæ„å»ºä¾¿æºç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- macOS
        if: matrix.package-type == 'portable' && github.event.inputs.skip_build == 'true' && matrix.os == 'macos-latest'
        shell: bash
        run: |
          echo "è·³è¿‡ç¼–è¯‘è¿‡ç¨‹ï¼Œåˆ›å»ºmacOSä¾¿æºç‰ˆè™šæ‹ŸåŒ…..."
          mkdir -p "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable"
          echo "æ¨¡æ‹Ÿæ„å»º" > "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable/README.txt"
          cd dist && zip -r "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable.zip" "GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable"

      # æ¨¡æ‹Ÿæ„å»ºå•æ–‡ä»¶ç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Windows
      - name: æ¨¡æ‹Ÿæ„å»ºå•æ–‡ä»¶ç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Windows
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build == 'true' && matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          echo "è·³è¿‡ç¼–è¯‘è¿‡ç¨‹ï¼Œåˆ›å»ºWindowså•æ–‡ä»¶ç‰ˆè™šæ‹ŸåŒ…..."
          mkdir -Force -Path dist
          "æ¨¡æ‹Ÿæ„å»º" | Out-File -FilePath "dist/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Standalone.exe"

      # æ¨¡æ‹Ÿæ„å»ºå•æ–‡ä»¶ç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Linux
      - name: æ¨¡æ‹Ÿæ„å»ºå•æ–‡ä»¶ç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- Linux
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build == 'true' && matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          echo "è·³è¿‡ç¼–è¯‘è¿‡ç¨‹ï¼Œåˆ›å»ºLinuxå•æ–‡ä»¶ç‰ˆè™šæ‹ŸåŒ…..."
          mkdir -p dist
          echo "æ¨¡æ‹Ÿæ„å»º" > "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Standalone"
          chmod +x "dist/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Standalone"

      # æ¨¡æ‹Ÿæ„å»ºå•æ–‡ä»¶ç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- macOS
      - name: æ¨¡æ‹Ÿæ„å»ºå•æ–‡ä»¶ç‰ˆï¼ˆè·³è¿‡å®é™…ç¼–è¯‘ï¼‰- macOS
        if: matrix.package-type == 'standalone' && github.event.inputs.skip_build == 'true' && matrix.os == 'macos-latest'
        shell: bash
        run: |
          echo "è·³è¿‡ç¼–è¯‘è¿‡ç¨‹ï¼Œåˆ›å»ºmacOSå•æ–‡ä»¶ç‰ˆè™šæ‹ŸåŒ…..."
          mkdir -p dist
          echo "æ¨¡æ‹Ÿæ„å»º" > "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone"
          chmod +x "dist/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone"

      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: GestroKey-${{ needs.get-version.outputs.version }}-${{ matrix.os }}-${{ matrix.package-type }}
          path: |
            dist/GestroKey-*.exe
            dist/GestroKey-*.zip
            dist/GestroKey-*.dmg
            dist/GestroKey-*.tar.gz
            dist/GestroKey-*-Standalone
            dist/GestroKey-*-Standalone.exe

  # åˆ›å»ºå‘å¸ƒ
  release:
    name: åˆ›å»ºç‰ˆæœ¬å‘å¸ƒ
    runs-on: ubuntu-latest
    needs: [get-version, build, check-changes]
    if: always() && needs.check-changes.outputs.should_build == 'true' && needs.get-version.outputs.enable_packaging == 'true'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ä»¥ä¾¿è·å–æ‰€æœ‰æ ‡ç­¾å’Œæäº¤

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
        run: find artifacts -type f | sort

      - name: è·å–æäº¤è®°å½•å¹¶ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: generate_changelog
        run: |
          # æ ¹æ®ç‰ˆæœ¬ç±»å‹ç¡®å®šä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾
          version_type="${{ needs.get-version.outputs.version_type }}"
          current_tag="${{ needs.get-version.outputs.release_name }}"
          
          # è·å–æ‰€æœ‰æ ‡ç­¾å¹¶æŒ‰ç‰ˆæœ¬æ’åº
          all_tags=$(git tag -l | grep -v "latest" | sort -V)
          
          # æ ¹æ®ç‰ˆæœ¬ç±»å‹æŸ¥æ‰¾ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾
          if [[ "$version_type" == "Development Version" ]]; then
            # æœªå‘å¸ƒç‰ˆï¼šç›®å‰æœ€æ–°çš„ç‰ˆæœ¬
            previous_tag=$(echo "$all_tags" | tail -n 1)
          elif [[ "$version_type" == "Preview Version" ]]; then
            # é¢„è§ˆç‰ˆï¼šé™¤latestå¤–çš„æœ€æ–°ç‰ˆæœ¬
            previous_tag=$(echo "$all_tags" | grep -v "$current_tag" | tail -n 1)
          else
            # å‘è¡Œç‰ˆï¼šä¸Šä¸€ä¸ªå‘è¡Œç‰ˆ
            previous_tag=$(echo "$all_tags" | grep -v "preview" | grep -v "$current_tag" | tail -n 1)
          fi
          
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾ï¼Œåˆ™ä¸ç”Ÿæˆæ›´æ–°æ—¥å¿—
          if [[ -z "$previous_tag" || "$previous_tag" == "$current_tag" ]]; then
            echo "æ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾ï¼Œè·³è¿‡æ›´æ–°æ—¥å¿—ç”Ÿæˆ"
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            echo "è¯¥ç‰ˆæœ¬ä¸ºé¦–ä¸ªå‘å¸ƒç‰ˆæœ¬ï¼Œæ— æ›´æ–°æ—¥å¿—ã€‚" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "å½“å‰ç‰ˆæœ¬ï¼š$current_tagï¼Œä¸Šä¸€ç‰ˆæœ¬ï¼š$previous_tag"
          
          # è·å–æäº¤è®°å½•
          commits=$(git log --pretty=format:"%s" $previous_tag..HEAD)
          
          # åˆå§‹åŒ–å„ä¸ªéƒ¨åˆ†çš„å†…å®¹
          features=""
          fixes=""
          docs=""
          styles=""
          refactors=""
          performances=""
          tests=""
          chores=""
          breaking_changes=""
          others=""
          
          # å®šä¹‰å…³è”æ•°ç»„æ¥å­˜å‚¨å·²æ·»åŠ çš„æè¿°ï¼Œç”¨äºå»é‡
          declare -A added_breaking_changes
          declare -A added_features
          declare -A added_fixes
          declare -A added_docs
          declare -A added_styles
          declare -A added_refactors
          declare -A added_performances
          declare -A added_tests
          declare -A added_chores
          declare -A added_others
          
          # è§£æ Conventional Commits æ ¼å¼çš„æäº¤ä¿¡æ¯
          while IFS= read -r commit; do
            # æ£€æŸ¥æ˜¯å¦åŒ…å«ç ´åæ€§å˜æ›´æ ‡è®°
            if [[ "$commit" =~ ^[a-zA-Z]+(\(.+\))?!:.*$ ]] || [[ "$commit" =~ BREAKING[[:space:]]CHANGE ]]; then
              # æå–æè¿°éƒ¨åˆ†ï¼ˆå»æ‰ç±»å‹å‰ç¼€ï¼‰
              description=$(echo "$commit" | sed -E 's/^[a-zA-Z]+(\(.+\))?!?:[[:space:]]*//')
              if [[ -z "${added_breaking_changes[$description]}" ]]; then
                breaking_changes="${breaking_changes}- ${description}\n"
                added_breaking_changes["$description"]=1
              fi
            elif [[ "$commit" =~ ^feat(\(.+\))?:[[:space:]]*(.+)$ ]]; then
              description="${BASH_REMATCH[2]}"
              if [[ -z "${added_features[$description]}" ]]; then
                features="${features}- ${description}\n"
                added_features["$description"]=1
              fi
            elif [[ "$commit" =~ ^fix(\(.+\))?:[[:space:]]*(.+)$ ]]; then
              description="${BASH_REMATCH[2]}"
              if [[ -z "${added_fixes[$description]}" ]]; then
                fixes="${fixes}- ${description}\n"
                added_fixes["$description"]=1
              fi
            elif [[ "$commit" =~ ^docs(\(.+\))?:[[:space:]]*(.+)$ ]]; then
              description="${BASH_REMATCH[2]}"
              if [[ -z "${added_docs[$description]}" ]]; then
                docs="${docs}- ${description}\n"
                added_docs["$description"]=1
              fi
            elif [[ "$commit" =~ ^style(\(.+\))?:[[:space:]]*(.+)$ ]]; then
              description="${BASH_REMATCH[2]}"
              if [[ -z "${added_styles[$description]}" ]]; then
                styles="${styles}- ${description}\n"
                added_styles["$description"]=1
              fi
            elif [[ "$commit" =~ ^refactor(\(.+\))?:[[:space:]]*(.+)$ ]]; then
              description="${BASH_REMATCH[2]}"
              if [[ -z "${added_refactors[$description]}" ]]; then
                refactors="${refactors}- ${description}\n"
                added_refactors["$description"]=1
              fi
            elif [[ "$commit" =~ ^perf(\(.+\))?:[[:space:]]*(.+)$ ]]; then
              description="${BASH_REMATCH[2]}"
              if [[ -z "${added_performances[$description]}" ]]; then
                performances="${performances}- ${description}\n"
                added_performances["$description"]=1
              fi
            elif [[ "$commit" =~ ^test(\(.+\))?:[[:space:]]*(.+)$ ]]; then
              description="${BASH_REMATCH[2]}"
              if [[ -z "${added_tests[$description]}" ]]; then
                tests="${tests}- ${description}\n"
                added_tests["$description"]=1
              fi
            elif [[ "$commit" =~ ^chore(\(.+\))?:[[:space:]]*(.+)$ ]]; then
              description="${BASH_REMATCH[2]}"
              if [[ -z "${added_chores[$description]}" ]]; then
                chores="${chores}- ${description}\n"
                added_chores["$description"]=1
              fi
            elif [[ "$commit" =~ ^(build|ci|revert)(\(.+\))?:[[:space:]]*(.+)$ ]]; then
              # å°† buildã€ciã€revert å½’ç±»åˆ°å…¶ä»–å˜æ›´
              description="${BASH_REMATCH[3]}"
              if [[ -z "${added_others[$description]}" ]]; then
                others="${others}- ${description}\n"
                added_others["$description"]=1
              fi
            else
              # ä¸ç¬¦åˆ Conventional Commits æ ¼å¼çš„æäº¤ï¼Œå½’ç±»åˆ°å…¶ä»–å˜æ›´
              description="$commit"
              if [[ -z "${added_others[$description]}" ]]; then
                others="${others}- ${description}\n"
                added_others["$description"]=1
              fi
            fi
          done <<< "$commits"
          
          # ç”Ÿæˆæ›´æ–°æ—¥å¿—
          changelog="## æ›´æ–°æ—¥å¿—\n\n"
          
          # ç ´åæ€§å˜æ›´ï¼ˆæœ€é‡è¦ï¼Œæ”¾åœ¨æœ€å‰é¢ï¼‰
          if [[ -n "$breaking_changes" ]]; then
            changelog="${changelog}### âš ï¸ ç ´åæ€§å˜æ›´\n\n${breaking_changes}\n"
          fi
          
          # æ–°åŠŸèƒ½
          if [[ -n "$features" ]]; then
            changelog="${changelog}### âœ¨ æ–°åŠŸèƒ½\n\n${features}\n"
          fi
          
          # é—®é¢˜ä¿®å¤
          if [[ -n "$fixes" ]]; then
            changelog="${changelog}### ğŸ› é—®é¢˜ä¿®å¤\n\n${fixes}\n"
          fi
          
          # æ€§èƒ½ä¼˜åŒ–
          if [[ -n "$performances" ]]; then
            changelog="${changelog}### âš¡ æ€§èƒ½ä¼˜åŒ–\n\n${performances}\n"
          fi
          
          # ä»£ç é‡æ„
          if [[ -n "$refactors" ]]; then
            changelog="${changelog}### â™»ï¸ ä»£ç é‡æ„\n\n${refactors}\n"
          fi
          
          # æ–‡æ¡£æ›´æ–°
          if [[ -n "$docs" ]]; then
            changelog="${changelog}### ğŸ“ æ–‡æ¡£æ›´æ–°\n\n${docs}\n"
          fi
          
          # ä»£ç é£æ ¼
          if [[ -n "$styles" ]]; then
            changelog="${changelog}### ğŸ’„ ä»£ç é£æ ¼\n\n${styles}\n"
          fi
          
          # æµ‹è¯•ç›¸å…³
          if [[ -n "$tests" ]]; then
            changelog="${changelog}### ğŸ§ª æµ‹è¯•ç›¸å…³\n\n${tests}\n"
          fi
          
          # æ„å»ºå’Œç»´æŠ¤
          if [[ -n "$chores" ]]; then
            changelog="${changelog}### ğŸ”§ æ„å»ºå’Œç»´æŠ¤\n\n${chores}\n"
          fi
          
          # å…¶ä»–å˜æ›´
          if [[ -n "$others" ]]; then
            changelog="${changelog}### ğŸ“¦ å…¶ä»–å˜æ›´\n\n${others}\n"
          fi
          
          # å¦‚æœæ²¡æœ‰ä»»ä½•å˜æ›´è®°å½•ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
          if [[ "$breaking_changes" == "" && "$features" == "" && "$fixes" == "" && "$docs" == "" && "$styles" == "" && "$refactors" == "" && "$performances" == "" && "$tests" == "" && "$chores" == "" && "$others" == "" ]]; then
            changelog="${changelog}*æœ¬æ¬¡ç‰ˆæœ¬æ›´æ–°æœªåŒ…å«ç¬¦åˆ Conventional Commits æ ¼å¼çš„æäº¤ä¿¡æ¯*\n"
          fi
          
          # è¾“å‡ºæ›´æ–°æ—¥å¿—ç»™åç»­æ­¥éª¤ä½¿ç”¨
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo -e "$changelog" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆä¸‹è½½é“¾æ¥è¡¨æ ¼å’Œè¯´æ˜
        id: generate_table
        run: |
          # æ ¹æ®ç‰ˆæœ¬ç±»å‹è®¾ç½®ä¸åŒçš„æ ‡é¢˜å’Œå†…å®¹
          if [[ "${{ needs.get-version.outputs.version_type }}" == "Development Version" ]]; then
            # æœªå‘å¸ƒç‰ˆæœ¬ä½¿ç”¨ç®€åŒ–æ ¼å¼
            echo "# GestroKey å¼€å‘ç‰ˆ ${{ needs.get-version.outputs.version }}" > release_description.md
            echo "" >> release_description.md
            echo "æ­¤ç‰ˆæœ¬ä¸ºè‡ªåŠ¨æ„å»ºçš„æœ€æ–°å¼€å‘ç‰ˆæœ¬ï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚" >> release_description.md
            echo "" >> release_description.md
            
            # ä»…æ·»åŠ ç®€åŒ–ç‰ˆæ›´æ–°æ—¥å¿—
            echo "## æ›´æ–°æ—¥å¿—" >> release_description.md
            echo "" >> release_description.md
            echo -e "${{ steps.generate_changelog.outputs.CHANGELOG }}" | grep -v "## æ›´æ–°æ—¥å¿—" >> release_description.md
            
            # æ·»åŠ æ„å»ºä¿¡æ¯
            echo "" >> release_description.md
            echo "---" >> release_description.md
            echo "æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> release_description.md
          else
            # æ­£å¼ç‰ˆå’Œé¢„è§ˆç‰ˆä¿æŒåŸæœ‰æ ¼å¼
            echo "" > release_description.md
            echo "## ä¸‹è½½é“¾æ¥" >> release_description.md
            echo "" >> release_description.md
            echo "| æ“ä½œç³»ç»Ÿ | å•æ–‡ä»¶ç‰ˆ | ä¾¿æºç‰ˆ |" >> release_description.md
            echo "|---------|---------|-------|" >> release_description.md
            echo "| Windows | [ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶](${{ needs.get-version.outputs.repo_url }}/releases/download/${{ needs.get-version.outputs.release_name }}/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Standalone.exe) | [ZIPå‹ç¼©åŒ…](${{ needs.get-version.outputs.repo_url }}/releases/download/${{ needs.get-version.outputs.release_name }}/GestroKey-${{ needs.get-version.outputs.version }}-Windows-Portable.zip) |" >> release_description.md
            echo "| macOS   | [ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶](${{ needs.get-version.outputs.repo_url }}/releases/download/${{ needs.get-version.outputs.release_name }}/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Standalone) | [ZIPå‹ç¼©åŒ…](${{ needs.get-version.outputs.repo_url }}/releases/download/${{ needs.get-version.outputs.release_name }}/GestroKey-${{ needs.get-version.outputs.version }}-macOS-Portable.zip) |" >> release_description.md
            echo "| Linux   | [ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶](${{ needs.get-version.outputs.repo_url }}/releases/download/${{ needs.get-version.outputs.release_name }}/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Standalone) | [TAR.GZå‹ç¼©åŒ…](${{ needs.get-version.outputs.repo_url }}/releases/download/${{ needs.get-version.outputs.release_name }}/GestroKey-${{ needs.get-version.outputs.version }}-Linux-Portable.tar.gz) |" >> release_description.md
            echo "" >> release_description.md
            
            # æ·»åŠ ç³»ç»Ÿè¦æ±‚
            echo "## ç³»ç»Ÿè¦æ±‚" >> release_description.md
            echo "" >> release_description.md
            echo "- **Windows**: Windows 10/11 64ä½" >> release_description.md
            echo "- **macOS**: macOS 11.0+ (Big SuråŠæ›´é«˜ç‰ˆæœ¬)" >> release_description.md
            echo "- **Linux**: ä¸»æµæ¡Œé¢å‘è¡Œç‰ˆ (Ubuntu 20.04+, Fedora 36+, Debian 11+)" >> release_description.md
            echo "" >> release_description.md
            
            # æ·»åŠ æ›´æ–°æ—¥å¿—
            echo -e "${{ steps.generate_changelog.outputs.CHANGELOG }}" >> release_description.md
            
            # æ·»åŠ æ„å»ºä¿¡æ¯
            echo "" >> release_description.md
            echo "---" >> release_description.md
            echo "" >> release_description.md
            echo "æ­¤ç‰ˆæœ¬ç”±GitHub Actionsè‡ªåŠ¨æ„å»ºäº $(date '+%Y-%m-%d %H:%M:%S %Z')" >> release_description.md
          fi
          
          # è¾“å‡ºå®Œæ•´å†…å®¹ç»™åç»­æ­¥éª¤ä½¿ç”¨
          echo "DESCRIPTION<<EOF" >> $GITHUB_OUTPUT
          cat release_description.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
      - name: æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
        id: check_tag
        uses: mukunku/tag-exists-action@v1.4.0
        with:
          tag: ${{ needs.get-version.outputs.release_name }}

      # åˆ é™¤å·²å­˜åœ¨çš„releaseå’Œæ ‡ç­¾
      - name: åˆ é™¤å·²å­˜åœ¨çš„releaseå’Œæ ‡ç­¾
        if: steps.check_tag.outputs.exists == 'true'
        run: |
          echo "ç§»é™¤å·²å­˜åœ¨çš„æ ‡ç­¾: ${{ needs.get-version.outputs.release_name }}"
          
          # ä½¿ç”¨GitHub CLIåˆ é™¤releaseå’Œæ ‡ç­¾
          gh release delete ${{ needs.get-version.outputs.release_name }} --yes || echo "Releaseä¸å­˜åœ¨æˆ–æ— æ³•åˆ é™¤"
          
          # åˆ é™¤è¿œç¨‹æ ‡ç­¾
          git tag -d ${{ needs.get-version.outputs.release_name }} || echo "æœ¬åœ°æ ‡ç­¾ä¸å­˜åœ¨"
          git push --delete origin ${{ needs.get-version.outputs.release_name }} || echo "è¿œç¨‹æ ‡ç­¾ä¸å­˜åœ¨æˆ–æ— æ³•åˆ é™¤"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      # å½“å‘å¸ƒæ­£å¼ç‰ˆæˆ–é¢„è§ˆç‰ˆæ—¶åˆ é™¤latestæ ‡ç­¾
      - name: åˆ é™¤latestæ ‡ç­¾
        if: needs.get-version.outputs.version_type != 'Development Version'
        run: |
          echo "å‘å¸ƒæ­£å¼ç‰ˆæˆ–é¢„è§ˆç‰ˆï¼Œåˆ é™¤latestæ ‡ç­¾"
          
          # æ£€æŸ¥latestæ ‡ç­¾æ˜¯å¦å­˜åœ¨
          if git ls-remote --tags origin | grep -q "refs/tags/latest"; then
            # åˆ é™¤GitHub Release
            gh release delete latest --yes || echo "Release latestä¸å­˜åœ¨æˆ–æ— æ³•åˆ é™¤"
            
            # åˆ é™¤è¿œç¨‹æ ‡ç­¾
            git push --delete origin latest || echo "è¿œç¨‹æ ‡ç­¾latestä¸å­˜åœ¨æˆ–æ— æ³•åˆ é™¤"
          else
            # å…¼å®¹æ€§æ£€æŸ¥ï¼šä¹Ÿå°è¯•åˆ é™¤æ—§çš„latestæ ‡ç­¾
            if git ls-remote --tags origin | grep -q "refs/tags/latest"; then
              gh release delete latest --yes || echo "Release latestä¸å­˜åœ¨æˆ–æ— æ³•åˆ é™¤"
              git push --delete origin latest || echo "è¿œç¨‹æ ‡ç­¾latestä¸å­˜åœ¨æˆ–æ— æ³•åˆ é™¤"
            else
              echo "æ ‡ç­¾latestä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤"
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾
      - name: åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾
        run: |
          # åˆ›å»ºæ ‡ç­¾
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          echo "åˆ›å»ºæ ‡ç­¾: ${{ needs.get-version.outputs.release_name }}"
          git tag -a ${{ needs.get-version.outputs.release_name }} -m "Release ${{ needs.get-version.outputs.release_name }}"
          
          # æ¨é€æ ‡ç­¾
          git push origin ${{ needs.get-version.outputs.release_name }}

      # åˆ›å»ºRelease
      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ needs.get-version.outputs.release_name }}
          tag_name: ${{ needs.get-version.outputs.release_name }}
          body: ${{ steps.generate_table.outputs.DESCRIPTION }}
          prerelease: ${{ needs.get-version.outputs.is_prerelease }}
          files: artifacts/*